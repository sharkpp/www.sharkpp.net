<?xml version="1.0" encoding="utf-8"?>
<feed xmlns="http://www.w3.org/2005/Atom">
    <title><![CDATA[さめたすたすのお家]]></title>
    <link href="http://www.sharkpp.net/blog/tags/https.xml" rel="self"/>
    <link href="http://www.sharkpp.net/"/>
    <updated>2020-12-30T02:25:31+00:00</updated>
    <id>http://www.sharkpp.net/</id>
            <author>
            <name><![CDATA[sharkpp]]></name>                    </author>
        <generator uri="http://sculpin.io/">Sculpin</generator>
            <entry>
            <title type="html"><![CDATA[ローカルでの HTTPS テスト環境の構築]]></title>
            <link href="http://www.sharkpp.net/blog/2020/05/02/build-local-https-test-environment.html"/>
            <updated>2020-05-02T16:15:00+00:00</updated>
            <id>http://www.sharkpp.net/blog/2020/05/02/build-local-https-test-environment.html</id>
            <content type="html"><![CDATA[<p>ローカルでのウェブアプリの開発では、もはや https が必須ということで動作確認に難儀していましたが、
しばらく前にローカルで認証局を簡単に設置できる <a href="https://github.com/FiloSottile/mkcert">mkcert</a> なるツールがあると知ったので、使い方を調べてみました。</p>

<p>PC上での使い方は結構サクッと出てきたので、実際のユースケースも念頭に Android でもオレオレ証明書が正規の証明書として利用できるような設定方法も調べてみました。</p>

<p><a href="/images/20200501_local_https_secure3.png"><img src="/thumbs/a68a390814458bbfe228d6e6d2fd6032-480x480.png" alt="20200501_local_https_secure3"></a></p>

<h2 id="mkcert-%E3%81%AE-windows-%E3%81%B8%E3%81%AE%E3%82%A4%E3%83%B3%E3%82%B9%E3%83%88%E3%83%BC%E3%83%AB">mkcert の Windows へのインストール</h2>

<p>mkcert の <a href="https://github.com/FiloSottile/mkcert#windows">Windows</a> セクションを参考にしてください。</p>

<h2 id="mkcert-%E3%81%AE-macos-%E3%81%B8%E3%81%AE%E3%82%A4%E3%83%B3%E3%82%B9%E3%83%88%E3%83%BC%E3%83%AB">mkcert の macOS へのインストール</h2>

<p>homebrew を使ったインストールが簡単です。</p>

<p><code>brew install mkcert</code> とターミナルで入力し実行するだけ。</p>

<pre><code class="console">$ brew install mkcert
Updating Homebrew...
==&gt; Auto-updated Homebrew!
           :
==&gt; Downloading https://homebrew.bintray.com/bottles/mkcert-1.4.1.mojave.bottle.tar.gz
==&gt; Downloading from https://akamai.bintray.com/91/9100c7f044d91e6ca0c483ed572217de28daa34c04fa6e2a130116175ba162e9?__gda__=exp=1588341913~hmac=516f50b8cbb6930276b
######################################################################## 100.0%
==&gt; Pouring mkcert-1.4.1.mojave.bottle.tar.gz
🍺  /usr/local/Cellar/mkcert/1.4.1: 6 files, 5.3MB
</code></pre>

<p>Firefox で利用する場合は</p>

<pre><code class="console">$ brew install nss
</code></pre>

<p>も必要なようです。</p>

<p>システムへのローカルの認証局のインストールは <code>mkcert -install</code> を実行するようです。</p>

<pre><code class="console">$ mkcert -install
Created a new local CA at "/Users/▒▒▒▒/Library/Application Support/mkcert" 💥
Sudo password: ******
The local CA is now installed in the system trust store! ⚡️
The local CA is now installed in the Firefox trust store (requires browser restart)! 🦊
</code></pre>

<h2 id="%E8%A8%BC%E6%98%8E%E6%9B%B8%E3%81%AE%E4%BD%9C%E6%88%90">証明書の作成</h2>

<p>証明書の作成は <code>mkcert {hostname_or_ip} ...</code> のような感じで、コマンドの後に証明書に含めたいホスト名もしくはIPを指定します。</p>

<pre><code class="console">$ mkcert 0.0.0.0 localhost 127.0.0.1 ::1
Using the local CA at "/Users/▒▒▒▒/Library/Application Support/mkcert" ✨

Created a new certificate valid for the following names 📜
 - "0.0.0.0"
 - "localhost"
 - "127.0.0.1"
 - "::1"

The certificate is at "./0.0.0.0+3.pem" and the key at "./0.0.0.0+3-key.pem" ✅
</code></pre>

<p>実行時のカレントディレクトリに <code>*.pem</code> = 公開鍵、と <code>*-key.pem</code> = 秘密鍵、が作成されるので、https として動作させる場合の公開鍵と秘密鍵として指定します。</p>

<h2 id="macos-%E3%81%A7%E5%88%A9%E7%94%A8%E3%81%99%E3%82%8B%E5%A0%B4%E5%90%88%E3%81%AE%E8%A8%AD%E5%AE%9A">macOS で利用する場合の設定</h2>

<p>mkcert をインストールしたPCでは、すでに、システムにローカル認証局の証明書がインストールされているので特に何かする必要はないです。</p>

<p>もし、他のPCで利用する場合は、下記に記載の方法で証明書のエクスポートをし、それをシステムにインストールしてください。</p>

<h2 id="android-%E3%81%A7%E5%88%A9%E7%94%A8%E3%81%99%E3%82%8B%E5%A0%B4%E5%90%88%E3%81%AE%E8%A8%AD%E5%AE%9A">Android で利用する場合の設定</h2>

<h3 id="%E8%A8%BC%E6%98%8E%E8%A8%BC%E3%81%AE%E3%82%A8%E3%82%AF%E3%82%B9%E3%83%9D%E3%83%BC%E3%83%88">証明証のエクスポート</h3>

<p>macOS の場合</p>

<p><a href="/images/20200501_ser_export_from_macos_key_chain.png"><img src="/thumbs/c75ff4d1123943a143ac45139cb90bad-320x320.png" alt="20200501_ser_export_from_macos_key_chain"></a></p>

<ol>
<li>「キーチェーン」を開く</li>
<li>左部「ログイン」を選択し <code>mkcert ▒▒▒▒▒▒▒▒▒▒▒▒</code> を探す、</li>
<li>右クリックメニューから「"mkcert ▒▒▒▒▒▒▒▒▒▒▒▒"を書き出す」を選んでファイルに保存</li>
<li>最後に、保存したファイルをなんとかして Android にコピーします。</li>
</ol>

<h3 id="%E8%A8%BC%E6%98%8E%E6%9B%B8%E3%81%AE%E3%82%A4%E3%83%B3%E3%82%B9%E3%83%88%E3%83%BC%E3%83%AB">証明書のインストール</h3>

<ol>
<li>「設定」アプリを開く</li>
<li>「セキュリティ」→「詳細設定」→「暗号化と認証情報」「ストレージからのインストール」<br/>
<a href="/images/20200501_android_ser_install1.png"><img src="/thumbs/6bb42b1c732f71567a936064644ba6d5-320x320.png" alt="20200501_android_ser_install1"></a> &nbsp; 
<a href="/images/20200501_android_ser_install2.png"><img src="/thumbs/88f2d30588e12d32fbf226959ed16813-320x320.png" alt="20200501_android_ser_install2"></a> &nbsp; 
<a href="/images/20200501_android_ser_install3.png"><img src="/thumbs/8bd3d02757906957b760e847338cd7cd-320x320.png" alt="20200501_android_ser_install3"></a></li>
<li>エクスポートした証明書を選択 <br/>
<a href="/images/20200501_android_ser_install4.png"><img src="/thumbs/62c7cfc3933d430dcb897d6bba06275c-320x320.png" alt="20200501_android_ser_install4"></a></li>
<li>「証明書の名前を指定する」欄は、適用に、「認証情報の使用」欄は「VPNとアプリ」を選択 <br/>
<a href="/images/20200501_android_ser_install5.png"><img src="/thumbs/1a96248fbb5fda8bcaad9f0dcbb0542f-320x320.png" alt="20200501_android_ser_install5"></a></li>
<li>「信頼できる認証局」→「ユーザー」タブを選択し、インストールした証明書が含まれていたらOK <br/>
<a href="/images/20200501_android_ser_install6.png"><img src="/thumbs/051861e5fc41fdc0088dc679493cb00a-320x320.png" alt="20200501_android_ser_install6"></a> &nbsp; 
<a href="/images/20200501_android_ser_install7.png"><img src="/thumbs/278ed200c9067da074fd3fa8cf75359c-320x320.png" alt="20200501_android_ser_install7"></a></li>
</ol>

<h2 id="%E8%A8%BC%E6%98%8E%E6%9B%B8%E3%81%AE%E5%88%A9%E7%94%A8">証明書の利用</h2>

<p>適当なウェブサーバーを使って確認します。</p>

<p>Node.js がインストール済みの場合は <a href="https://www.npmjs.com/package/http-server">http-server - npm</a> が簡単そうなので、</p>

<pre><code class="console">$ npm install -g http-server
</code></pre>

<p>としてインストールして試してみます。</p>

<p>HTML は適当に</p>

<pre><code class="html">&lt;html&gt;
  &lt;head&gt;
  &lt;/head&gt;
  &lt;body&gt;
    Is this page visible on https?
  &lt;/body&gt;
&lt;/html&gt;
</code></pre>

<p>みたいな感じに作ります。</p>

<p>カレントディレクトリに、前述の <code>0.0.0.0+3.pem</code> と <code>0.0.0.0+3-key.pem</code> を保存し</p>

<pre><code class="console">$ http-server . -S -C 0.0.0.0+3.pem -K .0.0.0.0+3-key.pem
</code></pre>

<p>とするとローカル認証局の証明書がインストールされていれば、有効な証明書として利用されます。</p>

<p>Chrome for Android で確認するとこんな感じ</p>

<p><a href="/images/20200501_local_https_secure1.png"><img src="/thumbs/dfdd71113e5de0382c1bc5946b5221e4-320x320.png" alt="20200501_local_https_secure1"></a> <a href="/images/20200501_local_https_secure2.png"><img src="/thumbs/066f32b6a759ac9254140508896c90e4-320x320.png" alt="20200501_local_https_secure2"></a></p>

<p>Chrome for macOS で確認するとこんな感じ</p>

<p><a href="/images/20200501_local_https_secure4.png"><img src="/thumbs/c8695d9aee7619d0fe3d7e780ac6cce1-320x320.png" alt="20200501_local_https_secure4"></a></p>

<h2 id="%E5%8F%82%E8%80%83">参考</h2>

<ul>
<li><a href="https://qiita.com/walkers/items/b90a97a99bbb27f6550f">ローカル環境でSSLをオレオレ証明書で行っていて警告が出てる人に朗報 - Qiita</a></li>
<li><a href="https://www.media.hiroshima-u.ac.jp/services/hinet/android-ca2">AndroidのCA証明書のインストールについて — Information Media Center</a></li>
<li><a href="https://support.google.com/pixelphone/answer/2844832?hl=ja">証明書を追加、削除する - Pixel Phone ヘルプ</a></li>
</ul>
]]></content>
        </entry>
            <entry>
            <title type="html"><![CDATA[じゅげむったーの開発日記 その６]]></title>
            <link href="http://www.sharkpp.net/blog/2017/09/27/jugemutter-development-diary-6th.html"/>
            <updated>2017-09-27T12:40:00+00:00</updated>
            <id>http://www.sharkpp.net/blog/2017/09/27/jugemutter-development-diary-6th.html</id>
            <content type="html"><![CDATA[<p>遅くなりましたが、今月も引き続き参加した <a href="https://qt-users.connpass.com/event/65548/">Qt 勉強会 @ Nagoya No12 - connpass</a> のまとめです。</p>

<p>重大発表があってちょっとびっくりでした。
それはともかく今回も長文投稿専用Twitterクライアントの開発の続きでした。</p>

<p>レポジトリは ... <a href="https://github.com/sharkpp/Jugemutter">sharkpp/Jugemutter: 長文投稿専用クライアント「じゅげむったー」</a> となります。</p>

<p>画面は...変わってないからいいですね。</p>

<h2 id="%E9%80%B2%E6%8D%97">進捗</h2>

<p>相変わらず <code>Could not authenticate you.</code> がなぜか出る、と。</p>

<p>そこで、先日に <a href="https://github.com/sharkpp/http-peeper">sharkpp/http-peeper: This is a proxy server for peeping HTTP/HTTPS communication, mainly for debugging.</a> と言うツールを NodeJS でサクッと作ってみました。
一言で言うと https 通信の間に割り込んで中身を見てしまうツールです。</p>

<p>今回は、これの改良というか改善？をして、他のソフトの通信の内容と比較してみました。</p>

<p>まあ、結果として、少なくともパラメータやヘッダなどには特に違いがなさそうだ、という事がわかりました。
困ったことに、全く解決になっていないです...</p>

<p>あとは、HMACなどの計算時に無駄にエスケープしている事で、サーバー側での検証時と値が違うのかなぁと。
まあ、そうだとすると Qt 側のバグなのですが...</p>

<p>と、まあそんなところで終了。</p>

<p>まあ、あとは重大発表として Qt 勉強会 @ Nagoya が残念なことに今回で一旦休止の発表があり（次回が一旦の〆）となってしまいました。
なかなか、会場の都合が付かないので難しいですねぇ。</p>

<h2 id="%E4%BB%96%E3%81%AE%E3%82%BD%E3%83%95%E3%83%88%E3%81%AE%E9%80%9A%E4%BF%A1%E3%82%92%E8%A6%97%E3%81%8D%E8%A6%8B">他のソフトの通信を覗き見</h2>

<p>先のツール（<a href="https://github.com/sharkpp/http-peeper">http-peeper</a>）、証明書は当然本物ではなく所謂オレオレ証明書と呼ばれているものを使っている都合、証明書の検証をしている（OpenSSL等のライブラリを使っている場合は基本検証している）とエラーが出てしまうのです。
そのために、そのままだと他のソフトには使えないのでした。
さてどうするか？と考えていたところ、そういえばオレオレ認証局の証明書を作りシステムに登録して信頼、その認証局で署名することで対応と書かれている記事を見かけた覚えがあったので、とりあえずツールに組み込む前に手作業でやって見ました。</p>

<h3 id="%E6%89%8B%E9%A0%86">手順</h3>

<p><code>openssl.conf</code> をコピーして書き換えたり、いろいろして見ましたが結局こんな感じで試しました。</p>

<pre><code class="console">$ mkdir demoCA
$ cd demoCA
$ mkdir newcerts certs crl private
$ chmod 700 private
$ touch index.txt
$ echo 00 |tee serial
$ openssl req -batch -new -x509 -sha256 -days 36500 -newkey rsa:4096 -out ca.crt -keyout demoCA/private/ca.key -subj "/C=JP/ST=Tokyo/L=Tokyo/O=root.http-peeper.local/OU=root.http-peeper.local/CN=root.http-peeper.local"
$ openssl rsa -in demoCA/private/ca.key -out demoCA/private/ca.key
$ openssl req -batch -new -sha256 -days 36500 -newkey rsa:4096 -out demoCA/server.csr -keyout demoCA/private/server.key -batch -subj "/C=JP/ST=Tokyo/L=Tokyo/O=root.http-peeper.local/OU=api.twitter.com/CN=api.twitter.com"
$ openssl rsa -in demoCA/private/server.key -out demoCA/private/server.key
$ openssl ca -batch -days 36500 -keyfile demoCA/private/ca.key -cert demoCA/ca.crt -in demoCA/server.csr -out demoCA/server.crt
</code></pre>

<p>そして <code>ca.crt</code> を開き</p>

<p><img src="/images/2017_0916_macos_cert_reg_to_system.png" alt="証明書の追加" /></p>

<p>と、システムに登録します。</p>

<p>登録したら「キーチェーンアクセス」から証明書を探し</p>

<p><img src="/images/2017_0916_macos_view_cert_detail.png" alt="証明書を右クリック" /></p>

<p>右クリックで「情報を見る」から「常に信頼」を選び</p>

<p><img src="/images/2017_0916_macos_trust_root_cert.png" alt="証明書を信頼" /></p>

<p>と信頼させます。</p>

<p><img src="/images/2017_0916_macos_trusted_cert.png" alt="キーチェーンアクセス" /></p>

<p>「キーチェーンアクセス」では「この証明書はこのアカウントにとって信頼されている物として指定されています」と表示されています。</p>

<p>あとは、 <code>server.key</code> と <code>server.crt</code> を</p>

<pre><code class="console">$ openssl x509 -in server.crt -out tmp.der -outform DER
$ openssl x509 -in tmp.der -inform DER -out server-cert.pem -outform pem
$ openssl rsa -in server.key -out tmp.der -outform DER
$ openssl rsa -in tmp.der -inform DER -out server-key.pem -outform pem
</code></pre>

<p>と .pem 形式に変換（元々.pemで利用していたため）し利用しました。</p>

<p>手順はツールに組み込んで自動化したいところですが、とりあえず他のソフトの通信を覗き見できるようになりました。</p>

<h2 id="%E5%8F%82%E8%80%83">参考</h2>

<ul>
<li><a href="http://qiita.com/mkgask/items/8d66dcada58a485e3585#_reference-0c1fe982bfae4639fb65">Chrome58以降でハネられないSHA-2でオレオレ認証局署名のあるオレオレ証明書 - Qiita</a></li>
<li><a href="http://qiita.com/ll_kuma_ll/items/13c962a6a74874af39c6#20170508%E8%BF%BD%E8%A8%98">オレだよオレオレ認証局で証明書つくる - Qiita</a></li>
<li><a href="http://qiita.com/softark/items/15a5280bd38c5dd97b48">オレオレ認証局とオレオレ証明書 - Qiita</a></li>
<li><a href="http://qiita.com/NakashimaKeisuke_zerodaynet/items/bfc77e5fe98b587532d0">SSL証明書設定でよくやってることをまとめる。 - Qiita</a></li>
<li><a href="http://qiita.com/kunichiko/items/12cbccaadcbf41c72735">RSA鍵、証明書のファイルフォーマットについて - Qiita</a></li>
<li><a href="https://hacknote.jp/archives/13939/">SSL証明書を.crtから.pemに変換する方法 | ハックノート</a></li>
<li><a href="http://certificate.fyicenter.com/2134_OpenSSL_ca_Error_..._directory_for_new_certificate_..._.html">OpenSSL - OpenSSL "ca" Error "... directory for new certificate ..."</a></li>
</ul>
]]></content>
        </entry>
            <entry>
            <title type="html"><![CDATA[じゅげむったーの開発日記 その５]]></title>
            <link href="http://www.sharkpp.net/blog/2017/08/23/jugemutter-development-diary-5th.html"/>
            <updated>2017-08-23T01:50:00+00:00</updated>
            <id>http://www.sharkpp.net/blog/2017/08/23/jugemutter-development-diary-5th.html</id>
            <content type="html"><![CDATA[<p>さて、今月も引き続き参加した <a href="https://qt-users.connpass.com/event/62861/">Qt 勉強会 @ Nagoya No11 - connpass</a> のまとめ。</p>

<p>つぶやきは <a href="https://togetter.com/li/1146658">Qt 勉強会 @ Nagoya No11 つぶやきまとめ - Togetterまとめ</a> でまとめられています。</p>

<p>先月の勉強会から日付(YY.MM)が付かなくなりました。</p>

<p>さて、今回も長文投稿専用Twitterクライアントの開発の続きをしました。</p>

<p>レポジトリは ... <a href="https://github.com/sharkpp/Jugemutter">sharkpp/Jugemutter: 長文投稿専用クライアント「じゅげむったー」</a> です。</p>

<p><img src="/images/2017_0819_jugemutter1.png" alt="画面" /></p>

<h2 id="%E9%80%B2%E6%8D%97">進捗</h2>

<p><img src="/images/2017_0819_jugemutter2.png" alt="テスト画面" /></p>

<p>とりあえず、分割処理のいろんなパターンのテストがやっと通ったので、ようやく一山越えた感じです。
ここまで長かった。</p>

<p>で、<code>Could not authenticate you.</code> がなぜか出る、と。
これは、<a href="https://dev.twitter.com/overview/api/response-codes">Error Codes &amp; Responses — Twitter Developers</a> によると、『<ruby>ダイヤルしても通話を完了できませんでした。<rp>(</rp><rt>Your call could not be completed as dialed.</rt><rp>)</rp></ruby>』って意味らしい。</p>

<h2 id="wireshark-%E3%81%A7-https-%E3%81%AE%E4%B8%AD%E8%BA%AB%E3%81%AE%E7%A2%BA%E8%AA%8D">Wireshark で https の中身の確認</h2>

<p>Twitter の API への指示がおかしいらしいので、なんとか調べられないかとググってた所、Wiresharkでhttpsの中身が確認できるとの記事を発見。</p>

<pre><code># SSLKEYLOGFILE=~/tls_key.log {ChromeやFirefox、cURLなどのパス}
</code></pre>

<p>で起動し、Wireshark で</p>

<p><img src="/images/2017_0819_https_decrypt_in_wireshark.png" alt="Wireshark" /></p>

<p>と、このような設定をすれば良いらしい。</p>

<p>が、解析画面</p>

<p><img src="/images/2017_0819_wireshark.png" alt="Wireshark" /></p>

<p>を見ても、 <del><code>Decrypted SSL Data</code> なんてタブはもちろん、<code>Frame</code> などのタブも表示されていないので、もしかしてUIがQtベースになった時に何か変わったのかもしれない。</del></p>

<p><img src="/images/2017_0831_wireshark.png" alt="Wireshark" /></p>

<p><code>RSA keys list</code> の設定を触って居たら、なぜかタブが出るようになった。
実装自体はされているようだ。</p>

<p>あと、そもそもの話、Qtの通信を覗きたいのが目的。
なので、Qtで上の方法が使えないと意味がないんだけど使えるのだろうか？</p>

<h2 id="%E5%8F%82%E8%80%83">参考</h2>

<ul>
<li><a href="http://qiita.com/Hexa/items/ce0ac23526df12a64ad0">暗号化された Application Data を復号する - Qiita</a></li>
<li><a href="https://f-o.org.uk/2017/decrypting-https-traffic-without-a-key.html">Floating Octothorpe: Decrypting HTTPS traffic without a key</a></li>
<li><a href="https://serverfault.com/questions/263530/how-can-i-filter-https-when-monitoring-traffic-with-wireshark">How can I filter https when monitoring traffic with Wireshark? - Server Fault</a></li>
<li><a href="http://troushoo.blog.fc2.com/blog-entry-234.html">Wireshark を用いて、クライアント側の情報のみでHTTPS 通信を複合する方法</a></li>
<li><a href="http://qiita.com/toshihirock/items/acbf9800f7e784118e46">HTTPSのパケットをwiresharkで見てみる - Qiita</a></li>
<li><a href="https://gist.github.com/summerwind/a482dd1f8e9887d26199">Wireshark で HTTP/2 over TLS の通信をダンプする方法</a></li>
<li><a href="https://developer.mozilla.org/en-US/docs/Mozilla/Projects/NSS/Key_Log_Format">NSS Key Log Format - Mozilla | MDN</a></li>
</ul>
]]></content>
        </entry>
    </feed>