<?xml version="1.0" encoding="utf-8"?>
<feed xmlns="http://www.w3.org/2005/Atom">
    <title><![CDATA[さめたすたすのお家]]></title>
    <link href="http://www.sharkpp.net/blog/tags/QNAP.xml" rel="self"/>
    <link href="http://www.sharkpp.net/"/>
    <updated>2020-07-29T14:51:13+00:00</updated>
    <id>http://www.sharkpp.net/</id>
            <author>
            <name><![CDATA[sharkpp]]></name>                    </author>
        <generator uri="http://sculpin.io/">Sculpin</generator>
            <entry>
            <title type="html"><![CDATA[QNAP TS-109II への syslog-ng の導入メモ]]></title>
            <link href="http://www.sharkpp.net/blog/2013/01/27/install-qnap-ts-109ii-syslog-ng.html"/>
            <updated>2013-01-27T13:27:00+00:00</updated>
            <id>http://www.sharkpp.net/blog/2013/01/27/install-qnap-ts-109ii-syslog-ng.html</id>
            <content type="html"><![CDATA[<p>なんか今使ってるNASも古くなってきたけど、まだまだ現役です。</p>

<p>ってことで、ルーターのログを取るために QNAP TS-109II への syslog-ng の導入をしたときのメモです。</p>

<h4 id="%E3%82%A4%E3%83%B3%E3%82%B9%E3%83%88%E3%83%BC%E3%83%AB">インストール</h4>

<pre><code># ipkg update
# ipkg install syslog-ng
</code></pre>

<h4 id="%E8%A8%AD%E5%AE%9A%E3%81%AE%E7%B7%A8%E9%9B%86">設定の編集</h4>

<pre><code># vi /opt/etc/syslog-ng/syslog-ng.conf
</code></pre>

<p>とりあえず、必須の設定</p>

<p>下記の２行を削除して</p>

<pre><code>source src { pipe("/proc/kmsg");unix-stream("/dev/log"); internal(); };
source net { udp(); };
</code></pre>

<p>設定を追加</p>

<pre><code>source src { file ("/proc/kmsg" log_prefix("kernel: ")); unix-stream ("/tmp/log"); internal(); };
source net { udp(ip(0.0.0.0) port(514)); tcp(ip(0.0.0.0) port(514)); };
</code></pre>

<p>これをしないと、</p>

<pre><code>Error binding socket; addr='AF_UNIX(/dev/log)', error='Address already in use (98)'
Error initializing source driver; source='src'
</code></pre>

<p>などと怒られる。</p>

<p>今回の目的、ルーターのログを保存するために、設定を追加。 これを設定してなくて、しばらく、ログが出てこないのはなぜだろうと悩んだのはここだけの秘密。</p>

<pre><code>destination router { file("/opt/var/log/router.log"); };
filter f_router { match("APXXXXXXXXXXXX "); };
log { source(net); filter(f_router); destination(router); };
log { source(net); destination(messages); };
</code></pre>

<p>既存のsyslogの停止</p>

<pre><code># /sbin/daemon_mgr qsyslogd stop /sbin/qsyslogd
# /sbin/daemon_mgr syslogd stop /sbin/syslogd
</code></pre>

<p>syslog-ngの起動</p>

<pre><code># syslog-ng start
</code></pre>

<h4 id="%E3%82%B9%E3%82%BF%E3%83%BC%E3%83%88%E3%82%A2%E3%83%83%E3%83%97%E3%81%AB%E7%99%BB%E9%8C%B2">スタートアップに登録</h4>

<p>QPKGの設定に追加することで機能の有効無効がUIから操作でき、また、自動実行もされるようになる。</p>

<pre><code># vi /etc/config/qpkg.conf
</code></pre>

<p>で下記内容を追加</p>

<pre><code>[syslog-ng]
Name = syslog-ng
Date = 2013-01-25
Enable = TRUE
Shell = /share/HDA_DATA/.scripts/syslog-ng_qpkg_start.sh
Install_Path = /share/HDA_DATA/.qpkg/Optware/etc
Author = me

# vi /share/HDA_DATA/.scripts/syslog-ng_qpkg_start.sh
</code></pre>

<p>で下記内容を保存</p>

<pre><code>#!/bin/sh

QPKG_NAME="syslog-ng"

THIS_SCRIPT="[$(basename $0)]"
LOG=echo
OPT=/share/HDA_DATA/.qpkg/Optware
LOG_FILE=${OPT}/var/log/scripts.log
SLEEP=10

$LOG $THIS_SCRIPT $(date "+[%Y-%m-%d %H:%M:%S]") $QPKG_NAME $1 | tee -a $LOG_FILE

_exit() {
   $LOG $THIS_SCRIPT $(date "+[%Y-%m-%d %H:%M:%S]") "Error: " $* | tee -a $LOG_FILE
   exit 1
}

_log() {
   $LOG $THIS_SCRIPT $(date "+[%Y-%m-%d %H:%M:%S]") $* | tee -a $LOG_FILE
}

case "$1" in
   start)
   pidof syslog-ng &amp;&amp; _exit "$QPKG_NAME already running. Exiting."

   pidof qsyslogd &amp;&amp; _log "Found qsyslogd. Killing it." &amp;&amp; /sbin/daemon_mgr qsyslogd stop /sbin/qsyslogd 

   pidof syslogd &amp;&amp; _log "Found syslogd. Killing it." &amp;&amp; /sbin/daemon_mgr syslogd stop /sbin/syslogd 

   _log "Starting $QPKG_NAME"
   /opt/sbin/syslog-ng start
   pidof $QPKG_NAME &amp;&amp; _log "$QPKG_NAME up and running"
   ;;

   stop)
   killall syslog-ng
   ;;

   restart)
   $0 stop; $0 start
   ;;

   *)
   _exit "Unknown command $1. Usage: $0 {start|stop|restart}"
esac
exit 0
</code></pre>

<h4 id="logrotate%E3%82%92%E3%82%A4%E3%83%B3%E3%82%B9%E3%83%88%E3%83%BC%E3%83%AB">logrotateをインストール</h4>

<pre><code># ipkg update
# ipkg install logrotate
</code></pre>

<h4 id="logrotate%E3%81%AE%E8%A8%AD%E5%AE%9A%E3%82%92%E7%B7%A8%E9%9B%86">logrotateの設定を編集</h4>

<pre><code># vi /opt/etc/logrotate.conf

#rotate 5
weekly
missingok
notifempty
delaycompress
compress

/opt/var/log/*.log
/opt/var/log/mail.*
/opt/var/log/messages
/opt/var/log/debug
/opt/var/log/syslog {
   postrotate
       /share/HDA_DATA/.scripts/syslog-ng_qpkg_start.sh restart
   endscript
}
</code></pre>

<h4 id="%E5%AE%9A%E6%9C%9F%E5%AE%9F%E8%A1%8C%E3%81%AE%E3%81%9F%E3%82%81crontab%E3%81%AB%E7%99%BB%E9%8C%B2">定期実行のためcrontabに登録</h4>

<pre><code># crontab -e
</code></pre>

<p>で下記のように編集し</p>

<pre><code>0 21 * * * /opt/sbin/logrotate /opt/etc/logrotate.conf
</code></pre>

<p>下記のコマンドで反映</p>

<pre><code>/etc/init.d/crond.sh restart
</code></pre>

<p>とりあえず、ログのローテートとはまだ未確認だけどルーターのログを保存できるようになったしよしとしよう。</p>

<h3 id="%E5%8F%82%E8%80%83">参考</h3>

<ul>
<li><a href="http://forum.qnap.com/viewtopic.php?f=121&amp;t=17151">QNAP NAS Community Forum - View topic - [HOWTO] Syslog-ng- receive router logs</a></li>
<li><a href="http://forum.qnap.com/viewtopic.php?t=5379">QNAP NAS Community Forum - View topic - where to link optware auto-start</a></li>
<li><a href="http://forum.qnap.com/viewtopic.php?t=11507">QNAP NAS Community Forum - View topic - rsyslog</a></li>
<li><a href="http://tokusan-sk49.cocolog-nifty.com/blog/2010/05/qnapsyslog-ng-c.html">QNAPにsyslog-ng: とくさんブログ</a></li>
<li><a href="http://www.marronkun.net/linux/other/syslogng_000047.html">syslog-ng.confの設定 : マロンくん.NET</a></li>
<li><a href="http://www.atmarkit.co.jp/fsecurity/rensai/unix_sec09/unix_sec01.html">＠IT：止められないUNIXサーバの管理対策 第9回</a></li>
</ul>
]]></content>
        </entry>
            <entry>
            <title type="html"><![CDATA[QNAP TS-109II と GALAXY S(SC-02B) をOpenVPNで繋ぐ]]></title>
            <link href="http://www.sharkpp.net/blog/2011/12/10/qnap-ts-109-galaxys-openvpn.html"/>
            <updated>2011-12-10T16:15:00+00:00</updated>
            <id>http://www.sharkpp.net/blog/2011/12/10/qnap-ts-109-galaxys-openvpn.html</id>
            <content type="html"><![CDATA[<p>NAS(QNAP TS-109II)をゴニョゴニョやりながらなんとかOpenVPN使って、3G/WiFi経由でGALAXY S(SC-02B)と通信できたのでメモ。</p>

<ul>
<li><a href="http://blog.circlea4.net/?p=406">QNAPへのインターネット経由でのOpenVPNアクセス</a></li>
<li><a href="http://wiki.nas-portal.org/index.php/Install_OpenVPN_on_QNAP">Install OpenVPN on QNAP - NAS Wiki</a></li>
<li><a href="http://photo.viasv.com/?p=3269">ViaPress inc. - SC-02B OpenVPN for Android</a></li>
<li><a href="http://beautiful-moon.net/2011-03-05_android-xperia-openvpn/">beautiful-moon.net - Blog Archive - Xperia(Android)からOpenVPN接続</a></li>
</ul>

<p>あたりを参考にした。</p>

<p>いずれも自己責任でお願いします。</p>

<p>特にAndroid側はroot化が必要なので高級文鎮にならないように注意が必要です。</p>

<p>最終的に</p>

<ul>
<li>QNAP TS-109II側の設定</li>
<li>GALAXY S(SC-02B)側の設定</li>
<li>LAN内部のクライアントと通信する</li>
</ul>

<p>と、順にGALAXY S⇔QNAP⇔WindowsPCまで通信できるようになりました。</p>

<h3 id="qnap-ts-109ii%E5%81%B4%E3%81%AE%E8%A8%AD%E5%AE%9A">QNAP TS-109II側の設定</h3>

<p>Optware ipkg は、<a href="/blog/2011/12/05/using-subversion-with-qnap-ts109II.html">QNAP TS-109II で Subversionを使う</a> で色々やったのでそちらを参考にしてください。</p>

<h4 id="openvpn%E3%82%92%E3%82%A4%E3%83%B3%E3%82%B9%E3%83%88%E3%83%BC%E3%83%AB">OpenVPNをインストール</h4>

<pre># ipkg install openvpn
</pre>

<pre># openvpn
</pre>

<p>で動けばとりあえずOK</p>

<h4 id="%E3%83%AD%E3%82%B0%E3%83%87%E3%82%A3%E3%83%AC%E3%82%AF%E3%83%88%E3%83%AA%E3%82%84tun%E3%83%A2%E3%82%B8%E3%83%A5%E3%83%BC%E3%83%AB%E7%94%A8%E3%81%AE%E3%83%87%E3%82%A3%E3%83%AC%E3%82%AF%E3%83%88%E3%83%AA%E3%82%92%E7%94%9F%E6%88%90">ログディレクトリやtunモジュール用のディレクトリを生成</h4>

<pre># cd /opt/etc/openvpn
---
title: "mkdir log"
date: 2011-12-10 16:15:00
tags: [雑記, Android, QNAP, Galaxy S]
categories: [ブログ]

---
---
title: "cd log"
date: 2011-12-10 16:15:00
tags: [雑記, Android, QNAP, Galaxy S]
categories: [ブログ]

---
---
title: "touch openvpn.log"
date: 2011-12-10 16:15:00
tags: [雑記, Android, QNAP, Galaxy S]
categories: [ブログ]

---
---
title: "touch status.log"
date: 2011-12-10 16:15:00
tags: [雑記, Android, QNAP, Galaxy S]
categories: [ブログ]

---
---
title: "mkdir /opt/etc/openvpn/modules"
date: 2011-12-10 16:15:00
tags: [雑記, Android, QNAP, Galaxy S]
categories: [ブログ]

---
</pre>

<p><a href="http://wiki.nas-portal.org/index.php/Install_OpenVPN_on_QNAP#Install_the_missing_tun.ko_module">Install the missing tun.ko module</a>から適切なtunモジュールをダウンロードし</p>

<pre>/opt/etc/openvpn/modules
</pre>

<p>に配置</p>

<p>起動時に、</p>

<pre># install tun.ko
mkdir /dev/net;
mknod /dev/net/tun c 10 200;
(sleep 10; insmod /opt/etc/openvpn/modules/tun.ko)&
easy.confの内容
---
title: "exec openvpn"
date: 2011-12-10 16:15:00
tags: [雑記, Android, QNAP, Galaxy S]
categories: [ブログ]

---
(sleep 10; /opt/sbin/openvpn /opt/etc/openvpn/easy.conf)&
</pre>

<p>が実行されるように、autorun.shなどに書き加える</p>

<p>easy.confの内容</p>

<pre># OpenVPN server configuration QNAP NAS
---
title: "basic settings"
date: 2011-12-10 16:15:00
tags: [雑記, Android, QNAP, Galaxy S]
categories: [ブログ]

---
port 1194
proto udp
dev tun
#
---
title: "detect mtu if the connection is slow."
date: 2011-12-10 16:15:00
tags: [雑記, Android, QNAP, Galaxy S]
categories: [ブログ]

---
; mtu-test
#
---
title: "define mtu, if necessary"
date: 2011-12-10 16:15:00
tags: [雑記, Android, QNAP, Galaxy S]
categories: [ブログ]

---
; tun-mtu xyz
#
---
title: "define the ip-addresses of the underlying tunnel"
date: 2011-12-10 16:15:00
tags: [雑記, Android, QNAP, Galaxy S]
categories: [ブログ]

---
server 10.8.0.0 255.255.255.0
#
---
title: "Route"
date: 2011-12-10 16:15:00
tags: [雑記, Android, QNAP, Galaxy S]
categories: [ブログ]

---
push "route 192.168.1.0 255.255.255.0"   #  &lt;--- LANのIPアドレスを指定
#
---
title: "certificates & keys"
date: 2011-12-10 16:15:00
tags: [雑記, Android, QNAP, Galaxy S]
categories: [ブログ]

---
dh   /opt/etc/openvpn/keys/dh1024.pem
ca   /opt/etc/openvpn/keys/ca.crt
cert /opt/etc/openvpn/keys/server.crt
key  /opt/etc/openvpn/keys/server.key
#
---
title: "data compression"
date: 2011-12-10 16:15:00
tags: [雑記, Android, QNAP, Galaxy S]
categories: [ブログ]

---
comp-lzo
#
---
title: "allow, that several clients with the same common name log on"
date: 2011-12-10 16:15:00
tags: [雑記, Android, QNAP, Galaxy S]
categories: [ブログ]

---
; duplicate-cn
#
---
title: "different clients can "see" each other through the tunnel."
date: 2011-12-10 16:15:00
tags: [雑記, Android, QNAP, Galaxy S]
categories: [ブログ]

---
; client-to-client
#
---
title: "Keepalive"
date: 2011-12-10 16:15:00
tags: [雑記, Android, QNAP, Galaxy S]
categories: [ブログ]

---
keepalive 15 120
#
---
title: "verbosity of status messages in the console. Activate for debugging (1-9 possible)"
date: 2011-12-10 16:15:00
tags: [雑記, Android, QNAP, Galaxy S]
categories: [ブログ]

---
; verb 5
#
---
title: "Log files"
date: 2011-12-10 16:15:00
tags: [雑記, Android, QNAP, Galaxy S]
categories: [ブログ]

---
status /share/HDA_DATA/system/log/openvpn-status.log
log-append /share/HDA_DATA/system/log/openvpn.log
#
---
title: "Run as daemon (activate, after everything is set up properly)"
date: 2011-12-10 16:15:00
tags: [雑記, Android, QNAP, Galaxy S]
categories: [ブログ]

---
; daemon
#
---
title: "Management Interface. Access with "telnet localhost 7505""
date: 2011-12-10 16:15:00
tags: [雑記, Android, QNAP, Galaxy S]
categories: [ブログ]

---
management localhost 7505
</pre>

<h3 id="galaxy-ssc-02b%E5%81%B4%E3%81%AE%E8%A8%AD%E5%AE%9A">GALAXY S(SC-02B)側の設定</h3>

<h4 id="android-market%E3%81%8B%E3%82%89%E5%BF%85%E8%A6%81%E3%81%AA%E3%82%A2%E3%83%97%E3%83%AA%E3%82%92%E3%82%A4%E3%83%B3%E3%82%B9%E3%83%88%E3%83%BC%E3%83%AB">Android Marketから必要なアプリをインストール</h4>

<p><a href="https://market.android.com/details?id=stericson.busybox&amp;hl=ja">BusyBox</a>、<a href="https://market.android.com/details?id=de.schaeuffelhut.android.openvpn.installer&amp;hl=ja">OpenVPN Installer</a>、<a href="https://market.android.com/details?id=de.schaeuffelhut.android.openvpn&amp;hl=ja">OpenVPN Settings</a>をインストール</p>

<p>あと、ターミナルソフト(<a href="https://market.android.com/details?id=org.connectbot">ConnectBot</a>/<a href="https://market.android.com/details?id=jackpal.androidterm">Android Terminal Emulator</a>など) or adbでも出来るかも？ も必要</p>

<p>OpenVPN関連のインストール先は、</p>

<pre>/system/xbin/
</pre>

<p>ifconfig/route関連のインストール先は、</p>

<pre>/system/xbin/bb/
</pre>

<p>にしました。</p>

<h4 id="ifconfig%2Froute%E3%81%AE%E9%85%8D%E7%BD%AE">ifconfig/routeの配置</h4>

<pre>su
---
title: "mount -o remount,rw /dev/block/stl9 /system"
date: 2011-12-10 16:15:00
tags: [雑記, Android, QNAP, Galaxy S]
categories: [ブログ]

---
---
title: "mkdir /system/xbin/bb"
date: 2011-12-10 16:15:00
tags: [雑記, Android, QNAP, Galaxy S]
categories: [ブログ]

---
---
title: "ln -s /system/xbin/busybox /system/xbin/bb/ifconfig"
date: 2011-12-10 16:15:00
tags: [雑記, Android, QNAP, Galaxy S]
categories: [ブログ]

---
---
title: "ln -s /system/xbin/busybox /system/xbin/bb/route"
date: 2011-12-10 16:15:00
tags: [雑記, Android, QNAP, Galaxy S]
categories: [ブログ]

---
</pre>

<p>で一旦、GALAXY Sを再起動</p>

<p>/sdcard/openvpn/galaxys/</p>

<p>にGALAXY S用のtunドライバ(tun-I9000-JPK.zip)を配置</p>

<p>※<a href="http://forum.xda-developers.com/showthread.php?t=793712">HOWTO tun.ko to run OpenVPN on Froyo xxJPK Galaxy S I9000 - xda-developers</a>からダウンロード</p>

<p>OpenVPN Settingsを起動して、Advancedを開き、</p>

<ol>
<li>「Load tun kernel module」にチェック</li>
<li>「TUN module settings」</li>
<li>　「Load modules usings」→ insmod を選択</li>
<li>　「Path to tun module」→ /sdcard/openvpn/galaxys/tun.ko と指定</li>
</ol>

<p><a href="http://wiki.nas-portal.org/index.php/Install_OpenVPN_on_QNAP#Key-generation">Key-generation</a>の手順で認証キーなどを作る</p>

<p>それぞれ、必要なファイルを指定したパス(/sdcard/openvpn/ca/)にアップ</p>

<p>vpn.confを配置</p>

<pre>/sdcard/openvpn/vpn.conf
</pre>

<p>に配置</p>

<p>vpn.confの内容</p>

<pre># connect to QNAP OpenVPN Server
script-security 2
proto udp
dev tun
tls-client
remote vpn.example.net 1194  #  &lt;--- enter your dyndns-account here!
pull
---
title: "set mtu, if necessary"
date: 2011-12-10 16:15:00
tags: [雑記, Android, QNAP, Galaxy S]
categories: [ブログ]

---
tun-mtu 1500
#
resolv-retry infinite
nobind
persist-key
persist-tun
---
title: "certificates and keys"
date: 2011-12-10 16:15:00
tags: [雑記, Android, QNAP, Galaxy S]
categories: [ブログ]

---
---
title: "Note the double \\ in the path for a windows config"
date: 2011-12-10 16:15:00
tags: [雑記, Android, QNAP, Galaxy S]
categories: [ブログ]

---
ca   /sdcard/openvpn/ca/ca.crt
cert /sdcard/openvpn/ca/key.crt
key  /sdcard/openvpn/ca/key.key
#
comp-lzo
#status /sdcard/openvpn/status.log
#log-append /sdcard/openvpn/log.log
</pre>

<p>設定の内容はサーバー側の設定と合わせないとうまく繋がりません。</p>

<p>ログを出力するようにしておくと原因の究明に役立つでしょう。</p>

<p>3Gだと実装で20kbpsも出ませんでしたのでまあやれることは限られていますがVPNで繋がるようになりました。</p>

<h3 id="lan%E5%86%85%E9%83%A8%E3%81%AE%E3%82%AF%E3%83%A9%E3%82%A4%E3%82%A2%E3%83%B3%E3%83%88%E3%81%A8%E9%80%9A%E4%BF%A1%E3%81%99%E3%82%8B">LAN内部のクライアントと通信する</h3>

<p><a href="http://wiki.nas-portal.org/index.php/OpenVPN_Extras">OpenVPN Extras - NAS Wiki</a>を参考</p>

<h4 id="qnap%E5%81%B4vpn%E3%82%B5%E3%83%BC%E3%83%90%E3%83%BC%E3%81%A7ipv4%E3%81%AE%E8%BB%A2%E9%80%81%E3%82%92%E6%9C%89%E5%8A%B9%E3%81%AB%E3%81%99%E3%82%8B">QNAP側(VPNサーバー)でipv4の転送を有効にする</h4>

<p>下記コマンドを 起動時に実行されるようにしておく</p>

<pre>echo "1" &gt; /proc/sys/net/ipv4/ip_forward
</pre>

<h4 id="windows-pc%E3%81%AE%E3%83%95%E3%82%A1%E3%82%A4%E3%83%AB%E5%85%B1%E6%9C%89%E3%82%92%E8%A6%8B%E3%82%8B">Windows PCのファイル共有を見る</h4>

<p>まず、クライアント側で</p>

<pre>C:\&gt; route -p add 10.8.0.0 MASK 255.255.255.0 QNAPのアドレス
</pre>

<p>としてパケットを送り返すことが出来るようにしておく。</p>

<p>ちなみに、-p を指定しておくとPCを再起動しても設定した内容を覚えておいてくれます。</p>

<pre>C:\&gt; route add ほげほげ
エラー: ネットワーク データベース ファイル ﾀﾉE を開けません
エラー: ネットワーク データベース ファイル ﾀﾉE を開けません
</pre>

<p>見たいに、エラーが出る場合は、自己の責任においてレジストリの</p>

<p>HKLM\SYSTEM\CurrentControlSet\Services\Tcpip\Parameters\DataBasePath</p>

<p>を、REG&#95;SZからREG&#95;EXPANG_SZに変えてみてください。</p>

<p>まえ、boost::asioでサンプルがうまく動かなかったのはこれが原因かもと今更気が付いた。</p>

<p>ここで、Windows PC⇔Galaxy S でpingの疎通確認をしておく</p>

<p>※Windows PC側は、pingの応答を返さないようになっていることが良くあるので設定を変更しておくこと</p>

<p>※ICMPの「エコー要求の着信を許可する」をONにしておくこと</p>

<p>問題なければ、ファイヤーウォールでファイル共有がローカルエリア外から接続できるかを確認</p>

<p>Windowsファイヤーウォールの場合</p>

<ol>
<li>「例外」</li>
<li>「ファイルとプリンタの共有」</li>
<li>「スコープの変更」</li>
<li>「ユーザーのネットワークのみ」になっていたら「カスタム一覧」にして「10.8.0.0/255.255.255.0,192.168.1.0/255.255.255.0」などに変更</li>
</ol>

<p>で、接続できると思います。</p>

<p>出来なかったら、Wiresharkで確認するのがイイです。</p>
]]></content>
        </entry>
            <entry>
            <title type="html"><![CDATA[QNAP TS-109II で Subversionを使う]]></title>
            <link href="http://www.sharkpp.net/blog/2011/12/05/using-subversion-with-qnap-ts109II.html"/>
            <updated>2011-12-05T00:23:00+00:00</updated>
            <id>http://www.sharkpp.net/blog/2011/12/05/using-subversion-with-qnap-ts109II.html</id>
            <content type="html"><![CDATA[<p>久しぶりに、NAS(QNAP TS-109II)の環境を作り直したのでメモ。</p>

<p>元々はsubversionを入れたいがためにdebianを入れていたけど、どうもそんな小難しいことをしなくてもSubversionを動かせるって情報を見つけたので今の環境を破棄してまで試してみる。</p>

<p>結論から言うとバックアップやら何やらで時間はかかったけど問題なく動きそう。</p>

<ul>
<li><a href="http://forum.qnap.com/viewtopic.php?f=32&amp;t=1779">Subversion over HTTP</a></li>
<li><a href="http://wiki.qnap.com/wiki/Subversion">Subversion - QNAPedia</a></li>
<li><a href="http://d.hatena.ne.jp/sugarball/20111029/1319896597">QNAP TS-439 Pro II+ Turbo NASにSubversionを構築 - sugarballの日記</a></li>
</ul>

<p>あたりを参考に、NAS(QNAP TS-109II)に、Apache+Subversionの環境を作ってみた</p>

<h3 id="optware-ipkg%E3%82%92%E3%82%A4%E3%83%B3%E3%82%B9%E3%83%88%E3%83%BC%E3%83%AB">Optware IPKGをインストール</h3>

<p>ApacheやSubversionをインストールするのに必要なIPKGを追加。</p>

<p><a href="http://wiki.qnap.com/wiki/Install_Optware_IPKG">Install Optware IPKG - QNAPedia</a>を参考にインストール。</p>

<ol>
<li>QNAPの管理画面を開く</li>
<li>「ホーム」→「アプリケーション」→「QPKGプラグイン」を開く</li>
<li>「QPKGの取得」を押下し、「Optware IPKG (Itsy Package Management System)」をダウンロード＆解凍</li>
<li>解凍した、"Optware_?.qpkg" を、「インストール」タブからインストール</li>
<li>「QPKGインストール済み」タブから、「Optware IPKG」を選び、「有効にする」を押下し有効にする</li>
</ol>

<p>有効にした直後のみipkgコマンドへパスが通るが、リブート以降パスが通らなくなるので</p>

<pre>export PATH=$PATH:/opt/bin:/opt/sbin
</pre>

<p>としておく</p>

<h3 id="apache2%E3%82%92%E3%82%A4%E3%83%B3%E3%82%B9%E3%83%88%E3%83%BC%E3%83%AB">Apache2をインストール</h3>

<p>ipkg install apache</p>

<p>すると↓のように mod&#95;ext&#95;filter.so が読み込めないとエラーが出る。</p>

<pre>httpd: Syntax error on line 74 of /opt/etc/apache2/httpd.conf: Cannot load /opt/libexec/mod_ext_filter.so into server: /opt/libexec/mod_ext_filter.so: undefined symbol: apr_procattr_limit_set<br />httpd: Syntax error on line 74 of /opt/etc/apache2/httpd.conf: Cannot load /opt/libexec/mod_ext_filter.so into server: /opt/libexec/mod_ext_filter.so: undefined symbol: apr_procattr_limit_set
</pre>

<p><a href="http://forum.synology.com/enu/viewtopic.php?f=34&amp;t=40959">mod&#95;ext&#95;filter.so: undefined symbol: apr&#95;procattr&#95;limit_set</a> を参考に設定を変更。</p>

<p>参考ページでも結局モジュールを読まないように変えるしかないようだ。</p>

<pre>vi /opt/etc/apache2/httpd.conf
</pre>

<p>で設定ファイルから libexec/mod&#95;ext&#95;filter.so を探しコメントアウト。</p>

<pre>httpd: bad user name nobody
</pre>

<p>と言われるのでユーザーを追加。</p>

<ol>
<li>QNAPの管理画面を開く</li>
<li>「ホーム」→「アクセス権管理」→「ユーザー」を開く</li>
<li>「ユーザーの追加」を押下</li>
</ol>

<ul>
<li>ユーザ名:nobody</li>
<li>容量制限の設定：無効にする</li>
<li>グループ：administrators, everyone</li>
<li>読み込みのみ：&#45;--</li>
<li>読み取り／書き込み：Public, Qdownload, Qmultimedia ...</li>
<li>アクセス拒否：&#45;--</li>
</ul>

<p>で追加</p>

<pre>httpd: Could not reliably determine the server's fully qualified domain name, using ? for ServerName
</pre>

<p>と言われるので設定を書き換え。</p>

<pre>ServerName nasserver:888
</pre>

<p>とかこんな感じ</p>

<p>もちろん例の場合、</p>

<pre>Listen 888
</pre>

<p>としておかないといけない</p>

<p>やることとしては、</p>

<ul>
<li>mod&#95;ext&#95;filter.so の設定を、httpd.conf からコメントアウト</li>
<li>ServerName(変更するならListenも)の設定を、httpd.conf に指定</li>
<li>QNAP管理画面から、nobodyユーザーを追加。</li>
</ul>

<pre>/opt/sbin/httpd -k start
</pre>

<p>で起動して http://nasserver:888/ などにブラウザでアクセスし、</p>

<p>It works!</p>

<p>と表示されたらOK</p>

<h3 id="subversion%E3%82%92%E3%82%A4%E3%83%B3%E3%82%B9%E3%83%88%E3%83%BC%E3%83%AB">Subversionをインストール</h3>

<pre>ipkg install svn
</pre>

<p>httpd.conf に↓を追加</p>

<pre>Include etc/apache2/conf.d/*.conf
</pre>

<p>レポジトリは、</p>

<pre>/share/HDA_DATA/svn
</pre>

<p>に設置</p>

<p>認証用のファイルは、</p>

<pre>/share/HDA_DATA/Qweb/repos/
</pre>

<p>に置く</p>

<p>HDA_DATAの部分は、製品によって違うようだ</p>

<p>.authz や .htpasswd</p>

<p>vi /opt/etc/apache2/conf.d/mod&#95;dav&#95;svn.conf に</p>

<pre>&lt;IfModule dav_svn_module&gt;<br /> &lt;Location "/repos/"&gt;<br />  DAV svn<br />  SVNParentPath /share/HDA_DATA/svn<br />  SVNListParentPath on<br />  AuthzSVNAccessFile /share/HDA_DATA/Qweb/repos/.authz<br />  &lt;IfModule dav_svn_module&gt;<br />   AuthType Basic<br />   AuthName "Authentication"<br />   AuthUserFile /share/HDA_DATA/Qweb/repos/.htpasswd<br />   Require valid-user<br />  &lt;/IfModule&gt;<br /> &lt;/Location&gt;<br /> &lt;Directory /share/HDA_DATA/Qweb/repos&gt;<br />  AllowOverride All<br />  Options All<br />  &lt;Limit GET POST OPTIONS&gt;<br />   Order allow,deny<br />   Allow from all<br />  &lt;/Limit&gt;<br />  &lt;LimitExcept GET POST OPTIONS PROPFIND MKACTIVITY CHECKOUT MKACTIVITY DELETE PROPPATCH MKCOL MERGE REPORT PUT COPY&gt;<br />   Order deny,allow<br />   Deny from all<br />  &lt;/LimitExcept&gt;<br /> &lt;/Directory&gt;<br />&lt;/IfModule&gt;
</pre>

<p>を追加。</p>

<pre>mkdir /share/HDA_DATA/svn<br />cd /share/HDA_DATA/svn<br />svnadmin create test
</pre>

<p>などしてレポジトリを作る</p>

<h3 id="apache%E3%81%AE%E8%87%AA%E5%8B%95%E8%B5%B7%E5%8B%95">Apacheの自動起動</h3>

<p><a href="http://wiki.qnap.com/wiki/Autorun.sh">Running Your Own Application at Startup - QNAPedia</a>を参考に</p>

<p>autorun.sh を編集</p>

<p>いちいちマウントするのが面倒なので、<a href="http://wiki.qnap.com/wiki/Autorun.sh#Method_3">Method 3</a> 方式で</p>

<p>/share/HDA_DATA/.qpkg/autorun/autorun.sh に</p>

<pre>(sleep 10; /opt/sbin/httpd -k start ) &
</pre>

<p>と追加</p>
]]></content>
        </entry>
    </feed>