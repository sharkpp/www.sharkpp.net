<?xml version="1.0" encoding="utf-8"?>
<feed xmlns="http://www.w3.org/2005/Atom">
    <title><![CDATA[さめたすたすのお家]]></title>
    <link href="http://www.sharkpp.net/blog/tags/Linux.xml" rel="self"/>
    <link href="http://www.sharkpp.net/"/>
    <updated>2021-12-31T01:17:24+00:00</updated>
    <id>http://www.sharkpp.net/</id>
            <author>
            <name><![CDATA[sharkpp]]></name>                    </author>
        <generator uri="http://sculpin.io/">Sculpin</generator>
            <entry>
            <title type="html"><![CDATA[Synology のパッケージのビルド方法について調べてみた]]></title>
            <link href="http://www.sharkpp.net/blog/2021/09/07/synology-package-building.html"/>
            <updated>2021-09-07T22:05:00+00:00</updated>
            <id>http://www.sharkpp.net/blog/2021/09/07/synology-package-building.html</id>
            <content type="html"><![CDATA[<p>Synology の NAS で利用可能なパッケージを作ってみようと思い、色々と調べてみました。
調べている最中に DSM 7.0 も正式リリースされたので、合わせてそのバージョンも調査の対象としました。</p>

<p>また、macOSでパッケージを作る場合の方法についても書きました。</p>

<p><a href="/images/20210907_dsm7_pkg_install_wizard_04.png"><img src="/thumbs/0f8b6887e5a96352c15cf2f29782e189-640x640.png" alt="パッケージインストールウィザード4"></a></p>

<h2 id="%E3%83%91%E3%83%83%E3%82%B1%E3%83%BC%E3%82%B8%E3%81%AE%E3%83%93%E3%83%AB%E3%83%89%E3%81%AB%E5%BF%85%E8%A6%81%E3%81%AA%E7%92%B0%E5%A2%83">パッケージのビルドに必要な環境</h2>

<p>ほぼ同じですが例としてあげられているUbuntuのLTSバージョンに変更がされているようです。</p>

<table>
<thead>
<tr>
  <th></th>
  <th>6.2</th>
  <th>7.0</th>
</tr>
</thead>
<tbody>
<tr>
  <td>OS</td>
  <td>64bitの一般的なLinux環境</br>(例として Ubuntu 16.04 LTS)</td>
  <td>64bitの一般的なLinux環境とルート権限</br>(例として Ubuntu 18.04 LTS)</td>
</tr>
<tr>
  <td>bash</td>
  <td>>= 4.1.5</td>
  <td>>= 4.1.5</td>
</tr>
<tr>
  <td>Python</td>
  <td>>= 2.7.3</td>
  <td>>= 2.7.3</td>
</tr>
</tbody>
</table>

<p>どちらも、NASに直接インストールすることはせず、必要であれば Docker パッケージをインストールしてツールキットを動かしてほしいと書かれています。</p>

<p>macOS は残念ながら一般的なLinux環境ではないので <a href="https://github.com/sharkpp/synology-toolkit-for-non-linux">synology-toolkit-for-non-linux</a> というソリューションを作って開発できるようにしてみました。</p>

<h2 id="dsm-6-%E3%81%A8-dsm-7-%E3%81%A8%E3%81%AE%E3%83%91%E3%83%83%E3%82%B1%E3%83%BC%E3%82%B8%E3%81%AE%E3%83%93%E3%83%AB%E3%83%89%E6%89%8B%E9%A0%86%E3%81%AE%E9%81%95%E3%81%84">DSM 6 と DSM 7 とのパッケージのビルド手順の違い</h2>

<p>どちらも <code>EnvDeploy</code> や <code>PkgCreate․py</code> への引数の与え方に違いはなさそうです。</p>

<p>ただ、処理の内容には多少の違いがあるようです。</p>

<h3 id="dsm-6.x">DSM 6.x</h3>

<p>利用可能なプラットフォーム：</p>

<blockquote>
  <p>6281 alpine alpine4k apollolake armada370 armada375 armada37xx armada38x armadaxp avoton braswell broadwell broadwellnk bromolow cedarview comcerto2k denverton dockerx64 evansport geminilake grantley hi3535 kvmx64 monaco purley qoriq rtd1296 v1000 x64</p>
</blockquote>

<ol>
<li><code>pkgscripts/EnvDeploy -v 6.2 -p x64</code></li>
<li><code>pkgscripts/PkgCreate.py -v 6.2 -p x64 -c ExamplePackage</code></li>
</ol>

<h3 id="dsm-7.x">DSM 7.x</h3>

<p>利用可能なプラットフォーム：</p>

<blockquote>
  <p>bromolow cedarview armadaxp armada370 armada375 evansport comcerto2k avoton alpine braswell apollolake grantley alpine4k monaco broadwell kvmx64 armada38x denverton rtd1296 broadwellnk purley armada37xx geminilake v1000</p>
</blockquote>

<ol>
<li><code>pkgscripts-ng/EnvDeploy -v 7.0 -p braswell</code></li>
<li><code>pkgscripts-ng/PkgCreate.py -v 7.0 -p braswell -c ExamplePackage</code></li>
</ol>

<p>破壊的変更により署名のフェーズがなくなっているようで指定可能な引数が少し変わっていました。</p>

<h2 id="%E3%83%91%E3%83%83%E3%82%B1%E3%83%BC%E3%82%B8%E6%89%8B%E5%8B%95%E3%81%AE%E3%82%A4%E3%83%B3%E3%82%B9%E3%83%88%E3%83%BC%E3%83%AB">パッケージ手動のインストール</h2>

<p>出来たパッケージを試すには、Synology NAS にログインし、パッケージセンターから「手動インストール」を行うことで可能です。</p>

<p><a href="/images/20210907_dsm7_pkg_install_wizard_01.png"><img src="/thumbs/58b7f462919d59664f552ef77692453e-640x640.png" alt="パッケージインストールウィザード1"></a> <a href="/images/20210907_dsm7_pkg_install_wizard_02.png"><img src="/thumbs/0f35caa7d01f65a9fa3ccb4a13634cd8-640x640.png" alt="パッケージインストールウィザード2"></a> <a href="/images/20210907_dsm7_pkg_install_wizard_03.png">&lt;img src="/thumbs/9065d65d3300b28ef4d44bbeff637082-640x640.png" alt="パッケージインストールウィザード3></a> <a href="/images/20210907_dsm7_pkg_install_wizard_04.png"><img src="/thumbs/0f8b6887e5a96352c15cf2f29782e189-640x640.png" alt="パッケージインストールウィザード4"></a></p>

<p>インストールすると、試した ExamplePackage では、こんな感じにアイコンなどが設置されました。</p>

<p><a href="/images/20210907_dsm7_pkg_installed_01.png"><img src="/thumbs/ad8bc929b38fad225bfc4ef559e72b96-640x640.png" alt="パッケージインストール後1"></a> <a href="/images/20210907_dsm7_pkg_installed_02.png"><img src="/thumbs/7153e28d5b00b6d1ff2caed92e4881af-640x640.png" alt="パッケージインストール後2"></a> <a href="/images/20210907_dsm7_pkg_installed_03.png"><img src="/thumbs/310c04c17c8ae499a3338d6345d4a71e-640x640.png" alt="パッケージインストール後3"></a></p>

<p>なお、後述のパッケージのお作法がちゃんとされていないと、インストール時に「ファイル形式が正しくありません、パッケージ管理者に連絡してください」("Invalid file format. Please contact the package developer.") と表示されるようです。</p>

<p><a href="/images/20210907_dsm7_pkg_invalid_file_type.png"><img src="/thumbs/bfeabb265236ddd91b028498dd139b03-640x640.png" alt="ファイル形式が正しくありません"></a></p>

<h2 id="dsm-6.x-%E3%81%8B%E3%82%89-7.0-%E3%81%B8%E5%AE%9F%E8%A3%85%E3%82%92%E5%A4%89%E6%9B%B4%E3%81%99%E3%82%8B%E5%A0%B4%E5%90%88%E3%81%AE%E4%B8%BB%E3%81%AA%E5%A4%89%E6%9B%B4%E7%82%B9">DSM 6.x から 7.0 へ実装を変更する場合の主な変更点</h2>

<p><a href="https://global.download.synology.com/download/Document/Software/DeveloperGuide/Firmware/DSM/7.0/enu/DSM_Developer_Guide_7_0_Beta.pdf">DSM Developer Guide 7.0 BETA</a> の <code>Breaking Changes in 7.0</code> (7.0 での破壊的変更) によると、DSM 6.x から DSM 7.x へは、パッケージフレームワークの次の点が変更されているようです。
下記の内容に従っていないと、パッケージのビルドが成功してもインストールすることができないなどが起こるようです。</p>

<table>
<thead>
<tr>
  <th>#</th>
  <th>項目</th>
  <th>DSM 6.x</th>
  <th>DSM 7.x</th>
</tr>
</thead>
<tbody>
<tr>
  <td>1</td>
  <td><a href="https://help.synology.com/developer-guide/privilege/privilege_config.html"><code>conf/privilege</code></a></td>
  <td>低い特権での実行をサポートしていないパッケージの場合は必須ではない</td>
  <td>必須</td>
</tr>
<tr>
  <td>2</td>
  <td><code>INFO.sh</code></td>
  <td>必須ではない</td>
  <td><code>package</code></br><code>version</code></br><code>os_min_ver="7.0-40000"</code> ※もしくはそれ以上</br><code>description</code></br><code>arch</code></br><code>maintainer</code></br>以上のフィールドが必要。</br>そうでないない場合は、ビルドは成功するがインストール時に「ファイル形式が正しくありません、パッケージ管理者に連絡してください」("Invalid file format. Please contact the package developer.") と表示される。</td>
</tr>
<tr>
  <td>3</td>
  <td>パッケージ署名</td>
  <td>必要</td>
  <td>不要(つまり、gnupg も不要)</td>
</tr>
<tr>
  <td>4</td>
  <td><code>conf/privilege</code> <code>defaults.run-as</code></td>
  <td><code>"package"</code></br><code>"system"</code></br><code>"root"</code></td>
  <td><code>"package"</code></br><code>"root"</code></br>特権操作はリソースワーカー経由での実行へ変更が必要</td>
</tr>
<tr>
  <td>5</td>
  <td>ホームパス</td>
  <td><code>/var/packages/[package_name]/target</code></td>
  <td><code>/var/packages/[package_name]/home</code></br>権限は <code>0700</code> <code>(rwx------)</code></td>
</tr>
<tr>
  <td>6</td>
  <td><code>PACKAGE_ICON.PNG</code></td>
  <td>72 x 72</td>
  <td>64 x 64</td>
</tr>
<tr>
  <td>7</td>
  <td>FHS ディレクトリの所有者</td>
  <td></td>
  <td><code>target</code> などの FHS ディレクトリは <code>conf/privilege</code> に従って新しい特権設定が行われます。</td>
</tr>
<tr>
  <td>8</td>
  <td>パッケージログの場所</td>
  <td><code>/var/log/synopkg.log</code></td>
  <td>パッケージ操作ログ：<code>/var/log/synopkg.log</code></br>コントロールスクリプトログ：<code>/var/log/packages/[package_name].log</code></td>
</tr>
<tr>
  <td>9</td>
  <td>システム起動時の開始確認</td>
  <td>されない</td>
  <td><code>INFO.sh</code>の<code>precheckstartstop="yes"</code>の場合にされる</td>
</tr>
</tbody>
</table>

<h2 id="pkgcreate%E2%80%A4py-%E3%81%AE%E4%BD%BF%E3%81%84%E6%96%B9">PkgCreate․py の使い方</h2>

<p>とりあえず <code>pkgscripts/PkgCreate.py -v {バージョン} -p {プラットフォーム} -c {パッケージ名}</code> でことは足りる。</p>

<pre><code class="console">usage: PkgCreate.py [-h] [-p PLATFORMS] [-e ENV_SECTION] [-v ENV_VERSION] [-x DEP_LEVEL] [-X PARALLEL_PROJ] [-b BRANCH] [-s SUFFIX] [-c] [--no-collecter] [-L] [-l] [-B] [-I] [-i]
                    [-P PARALLEL] [--build-opt BUILD_OPT] [--install-opt INSTALL_OPT] [--print-log] [--no-tee] [--min-sdk SDK_VER]
                    package

固定引数:
  package               対象のパッケージ

オプションの引数:
  -h, --help            このヘルプメッセージを表示して終了
  -p PLATFORMS          ターゲットプラットフォームを指定。 省略時では、build_env/ 以下の利用可能なプラットフォームを検出。
  -e ENV_SECTION, --env ENV_SECTION
                        環境セクションを SynoBuildConf/depends で指定。省略時は [default] 。
  -v ENV_VERSION, --version ENV_VERSION
                        ターゲットDSMバージョンを手動で指定。
  -x DEP_LEVEL          ビルド依存レベルを指定
  -X PARALLEL_PROJ      SynoBuild　並列ビルドプロジェクト。 0 は 2 つの並列ジョブでビルドすることを意味。
  -b BRANCH             パッケージのブランチを指定。
  -s SUFFIX             ビルド環境のフォルダのサフィックス (build_env/) を指定。
  -c                    パッケージを収集。
  --no-collecter        すべての収集動作をスキップ。
  -L                    プロジェクトをリンクしません。
  -l                    プロジェクトを更新してリンク。
  -B                    プロジェクトを構築しない。
  -I                    プロジェクトをインストールしない。
  -i                    プロジェクトのみをインストール。
  -P PARALLEL           並列プラットフォーム、省略時は 2
  --build-opt BUILD_OPT 
                        SynoBuild への引数パス
  --install-opt INSTALL_OPT
                        SynoInstall への引数パス
  --print-log           SynoBuild/SynoInstall のエラーログを印字。
  --no-tee              stdout/stderr　をログに記録しません。
  --min-sdk SDK_VER     最小 SDK バージョン、省略時=6.2
</code></pre>

<h2 id="envdeploy-%E3%82%84-pkgcreate%E2%80%A4py-%E3%81%AA%E3%81%A9%E3%81%A7%E5%88%A9%E7%94%A8%E5%8F%AF%E8%83%BD%E3%81%AA%E3%83%97%E3%83%A9%E3%83%83%E3%83%88%E3%83%95%E3%82%A9%E3%83%BC%E3%83%A0">EnvDeploy や PkgCreate․py などで利用可能なプラットフォーム</h2>

<p>型番からプラットフォームを調べる場合は <a href="https://kb.synology.com/en-global/DSM/tutorial/What_kind_of_CPU_does_my_NAS_have">What kind of CPU does my Synology NAS have?</a> を参照する。</p>

<table>
<thead>
<tr>
  <th>プラットフォーム</th>
  <th>6.2</th>
  <th>7.0</th>
</tr>
</thead>
<tbody>
<tr>
  <td>6281</td>
  <td>利用可能</td>
  <td>−</td>
</tr>
<tr>
  <td>dockerx64</td>
  <td>利用可能</td>
  <td>−</td>
</tr>
<tr>
  <td>hi3535</td>
  <td>利用可能</td>
  <td>−</td>
</tr>
<tr>
  <td>qoriq</td>
  <td>利用可能</td>
  <td>−</td>
</tr>
<tr>
  <td>x64</td>
  <td>利用可能</td>
  <td>−</td>
</tr>
<tr>
  <td>alpine</td>
  <td>利用可能</td>
  <td>利用可能</td>
</tr>
<tr>
  <td>alpine4k</td>
  <td>利用可能</td>
  <td>利用可能</td>
</tr>
<tr>
  <td>apollolake</td>
  <td>利用可能</td>
  <td>利用可能</td>
</tr>
<tr>
  <td>armada370</td>
  <td>利用可能</td>
  <td>利用可能</td>
</tr>
<tr>
  <td>armada375</td>
  <td>利用可能</td>
  <td>利用可能</td>
</tr>
<tr>
  <td>armada37xx</td>
  <td>利用可能</td>
  <td>利用可能</td>
</tr>
<tr>
  <td>armada38x</td>
  <td>利用可能</td>
  <td>利用可能</td>
</tr>
<tr>
  <td>armadaxp</td>
  <td>利用可能</td>
  <td>利用可能</td>
</tr>
<tr>
  <td>avoton</td>
  <td>利用可能</td>
  <td>利用可能</td>
</tr>
<tr>
  <td>braswell</td>
  <td>利用可能</td>
  <td>利用可能</td>
</tr>
<tr>
  <td>broadwell</td>
  <td>利用可能</td>
  <td>利用可能</td>
</tr>
<tr>
  <td>broadwellnk</td>
  <td>利用可能</td>
  <td>利用可能</td>
</tr>
<tr>
  <td>bromolow</td>
  <td>利用可能</td>
  <td>利用可能</td>
</tr>
<tr>
  <td>cedarview</td>
  <td>利用可能</td>
  <td>利用可能</td>
</tr>
<tr>
  <td>comcerto2k</td>
  <td>利用可能</td>
  <td>利用可能</td>
</tr>
<tr>
  <td>denverton</td>
  <td>利用可能</td>
  <td>利用可能</td>
</tr>
<tr>
  <td>evansport</td>
  <td>利用可能</td>
  <td>利用可能</td>
</tr>
<tr>
  <td>geminilake</td>
  <td>利用可能</td>
  <td>利用可能</td>
</tr>
<tr>
  <td>grantley</td>
  <td>利用可能</td>
  <td>利用可能</td>
</tr>
<tr>
  <td>kvmx64</td>
  <td>利用可能</td>
  <td>利用可能</td>
</tr>
<tr>
  <td>monaco</td>
  <td>利用可能</td>
  <td>利用可能</td>
</tr>
<tr>
  <td>purley</td>
  <td>利用可能</td>
  <td>利用可能</td>
</tr>
<tr>
  <td>rtd1296</td>
  <td>利用可能</td>
  <td>利用可能</td>
</tr>
<tr>
  <td>v1000</td>
  <td>利用可能</td>
  <td>利用可能</td>
</tr>
</tbody>
</table>

<h2 id="macos%E3%81%A7%E3%83%91%E3%83%83%E3%82%B1%E3%83%BC%E3%82%B8%E3%82%92%E3%83%93%E3%83%AB%E3%83%89%E3%81%99%E3%82%8B%E3%81%AB%E3%81%AF%EF%BC%9F">macOSでパッケージをビルドするには？</h2>

<p>macOS で簡単にパッケージがビルドできるように <a href="https://github.com/sharkpp/synology-toolkit-for-non-linux">synology-toolkit-for-non-linux</a> というソリューションを作りました。</p>

<p>使い方は、まずレポジトリを clone して、環境を構築。</p>

<pre><code class="console">$ git clone https://github.com/sharkpp/synology-toolkit-for-non-linux.git
$ cd synology-toolkit-for-non-linux
$ docker/build.sh
</code></pre>

<p>次に、 <code>EnvDeploy</code> でツールキットをダウンロード</p>

<pre><code class="console">$ pkgscripts/EnvDeploy -v 7.0 -p braswell
</code></pre>

<p>最後に <code>source</code> フォルダにパッケージのソースを入れ <code>PkgCreate․py</code> でビルド。
ここでは <a href="https://github.com/SynologyOpenSource/ExamplePackages/tree/main/ExamplePackage"><code>ExamplePackage</code></a> を利用。</p>

<pre><code class="console">$ git clone https://github.com/SynologyOpenSource/ExamplePackages.git source/ExamplePackages
$ mv source/ExamplePackages/ExamplePackage source
$ pkgscripts/PkgCreate.py -v 7.0 -p braswell -c ExamplePackage
</code></pre>

<p><code>result_spk</code> フォルダにビルドされたパッケージが置かれます。</p>

<h2 id="%E5%8F%82%E8%80%83%E3%81%AB%E3%81%AA%E3%82%8A%E3%81%9D%E3%81%86%E3%81%AA%E3%83%91%E3%83%83%E3%82%B1%E3%83%BC%E3%82%B8">参考になりそうなパッケージ</h2>

<p><a href="https://github.com/search?q=os_min_ver+filename%3AINFO&amp;type=Code&amp;ref=advsearch&amp;l=&amp;l=">Search · os_min_ver filename:INFO</a> で適当に検索してリストアップしてみました。</p>

<table>
<thead>
<tr>
  <th>パッケージ名</th>
  <th>DSM</th>
  <th>概要</th>
</tr>
</thead>
<tbody>
<tr>
  <td><a href="https://github.com/SynologyOpenSource/ExamplePackages/tree/main/ExamplePackage"><code>ExamplePackage</code></a></td>
  <td>7.0</td>
  <td>公式サンプルパッケージ</td>
</tr>
<tr>
  <td><a href="https://github.com/SynologyOpenSource/ExamplePackages/tree/main/nmap"><code>nmap</code></a></td>
  <td>7.0</td>
  <td>公式サンプル nmap パッケージ</td>
</tr>
<tr>
  <td><a href="https://github.com/prabirshrestha/synology-package-template"><code>synology-package-template</code></a></td>
  <td>7.0/6.x</td>
  <td>サンプルパッケージ</td>
</tr>
<tr>
  <td><a href="https://github.com/tailscale/tailscale-synology"><code>Tailscale package</code></a></td>
  <td>7.0/6.x</td>
  <td>Tailscale VPN パッケージ？</td>
</tr>
<tr>
  <td><a href="https://github.com/vladlenas/Synology-TorrServer"><code>TorrServer package</code></a></td>
  <td>7.0/6.x</td>
  <td>TorrServerパッケージ</td>
</tr>
<tr>
  <td><a href="https://github.com/runfalk/synology-wireguard"><code>WireGuard package</code></a></td>
  <td>7.0/6.x</td>
  <td>WireGuardパッケージ</td>
</tr>
<tr>
  <td><a href="https://github.com/reidemei/synology-autorun"><code>autorun</code></a></td>
  <td>7.0/6.x</td>
  <td>Synology NASで外付けドライブ（USB / eSATA）を接続するときにスクリプトを実行</td>
</tr>
</tbody>
</table>

<h2 id="%E5%8F%82%E8%80%83">参考</h2>

<ul>
<li><a href="https://github.com/SynologyOpenSource/pkgscripts-ng/tree/DSM6.0">GitHub - SynologyOpenSource/pkgscripts-ng at DSM6.0</a></li>
<li><a href="https://help.synology.com/developer-guide/getting_started/prepare_environment.html">Prepare Envrionment · GitBook</a></li>
<li><a href="https://github.com/SynologyOpenSource/minimalPkg/issues/5">Unable to Sign package with GPG key · Issue #5 · SynologyOpenSource/minimalPkg · GitHub</a></li>
<li><a href="https://qiita.com/yagince/items/deba267f789604643bab">Docker Ubuntu18.04でtzdataをinstallするときにtimezoneの選択をしないでinstallする - Qiita</a></li>
<li><a href="https://kb.synology.com/ja-jp/DSM/tutorial/What_kind_of_CPU_does_my_NAS_have">Synology NAS に搭載されている CPU の種類は？ - Synology ナレッジセンター</a></li>
<li><a href="https://global.download.synology.com/download/Document/Software/DeveloperGuide/Firmware/DSM/7.0/enu/DSM_Developer_Guide_7_0_Beta.pdf">DSM Developer Guide 7.0 BETA</a></li>
<li><a href="https://global.download.synology.com/download/Document/Software/DeveloperGuide/Firmware/DSM/6.0/enu/DSM_Developer_Guide_6_0.pdf">Synology DSM6.0 Developer Guide</a></li>
</ul>
]]></content>
        </entry>
            <entry>
            <title type="html"><![CDATA[Sculpin を実行するために xrea.com 上で libxml2 を構築する方法]]></title>
            <link href="http://www.sharkpp.net/blog/2015/05/31/how-to-build-libxml2-on-xrea-com-for-sculpin.html"/>
            <updated>2015-05-31T21:30:00+00:00</updated>
            <id>http://www.sharkpp.net/blog/2015/05/31/how-to-build-libxml2-on-xrea-com-for-sculpin.html</id>
            <content type="html"><![CDATA[<p>Sculpin を xrea.com で動かそうとしたら、</p>

<pre><code class="bash"># php55cli sculpin.phar self-update

  [Symfony\Component\DependencyInjection\Exception\InvalidArgumentException]
  Unable to parse file "phar:///virtual/XXXXXX/sculpin.phar/src/Sculpin/Bundle/
  StandaloneBundle/DependencyInjection/../Resources/config/services.xml".

  [InvalidArgumentException]
  [ERROR 3070] complex type 'container': The content model is not determinist.
   (in file:////tmp/sf2aedR4G - line 20, column 0)
</code></pre>

<p>って言われた。</p>

<p>で、調べてみると <code>libxml</code> のバージョンによる問題っぽい感じ。</p>

<pre><code class="bash"># ls -l /usr/lib/libxml*
lrwxrwxrwx  1 root root      17 2006-07-24 11:38 /usr/lib/libxml2.so.2 -&gt; libxml2.so.2.6.20
-rwxr-xr-x  1 root root 1223256 2005-09-10 01:31 /usr/lib/libxml2.so.2.6.20
</code></pre>

<p>なので <code>libxml</code> をビルドしてみることにした。</p>

<p>s152.xrea.com サーバーで作業したので他のサーバーだとスペックが違うかもですが失敗も含め作業をメモしています。</p>

<p>作業記録を兼ね失敗したことなども含め書いてあるので色々長いため、結論だけ知りたい場合は <a href="/blog/2015/05/31/how-to-build-libxml2-on-xrea-com-for-sculpin.html#%E3%81%BE%E3%81%A8%E3%82%81">まとめ</a> まですっ飛ばすことをお勧めします。</p>

<h2 id="libxml-%E3%82%92%E3%83%80%E3%82%A6%E3%83%B3%E3%83%AD%E3%83%BC%E3%83%89%EF%BC%86%E3%83%93%E3%83%AB%E3%83%89%E2%86%92%E5%A4%B1%E6%95%97">libxml をダウンロード＆ビルド→失敗</h2>

<p>とりあえず <code>libxml</code> を <a href="https://git.gnome.org/browse/libxml2/">libxml2 - XML parser and markup toolkit</a> からダウンロードして解凍。</p>

<pre><code class="bash"># pwd
~
# mkdir build
# cd build
# curl -kLO https://git.gnome.org/browse/libxml2/snapshot/libxml2-2.9.2.tar.xz
# tar xf libxml2-2.9.2.tar.xz
# cd libxml2-2.9.2
</code></pre>

<p><code>configure</code> が無いので <code>automake</code> で <code>configure</code> を作ってみる、、、がうまく行かなかった。</p>

<pre><code class="bash"># pwd
~/build/libxml2-2.9.2
# ls -l configure.ac
-rw-r--r--  1 XXXXXX XXXXXX 44763 2014-10-16 16:40 configure.ac
# aclocal
/usr/share/aclocal/progsreiserfs.m4:13: warning: underquoted definition of AC_CHECK_LIBREISERFS
  run info '(automake)Extending aclocal'
  or see http://sources.redhat.com/automake/automake.html#Extending-aclocal
/usr/local/share/aclocal/libmcrypt.m4:17: warning: underquoted definition of AM_PATH_LIBMCRYPT
configure.ac:2: error: Autoconf version 2.63 or higher is required
configure.ac:2: the top level
autom4te: /usr/bin/m4 failed with exit status: 63
aclocal: autom4te failed with exit status: 63
</code></pre>

<p><a href="https://bugs.archlinux.org/task/20172#comments">FS#20172 : [progsreiserfs] underquoted definition of AC_CHECK_LIBREISERFS</a> を見てファイルをコピーし、修正してみるも</p>

<pre><code class="bash"># pwd
~/build/libxml2-2.9.2
# cp -pr /usr/share/aclocal/ ../aclocal
# vi ../aclocal/progsreiserfs.m4
# diff /usr/share/aclocal/progsreiserfs.m4 ../aclocal/progsreiserfs.m4
13c13
&lt; AC_DEFUN(AC_CHECK_LIBREISERFS,
---
&gt; AC_DEFUN([AC_CHECK_LIBREISERFS],
# aclocal --acdir=../aclocal
/usr/local/share/aclocal/libmcrypt.m4:17: warning: underquoted definition of AM_PATH_LIBMCRYPT
  run info '(automake)Extending aclocal'
  or see http://sources.redhat.com/automake/automake.html#Extending-aclocal
aclocal:configure.ac:52: warning: macro `AM_INIT_AUTOMAKE' not found in library
aclocal:configure.ac:89: warning: macro `AM_CONDITIONAL' not found in library
aclocal:configure.ac:216: warning: macro `AM_CONDITIONAL' not found in library
aclocal:configure.ac:901: warning: macro `AM_CONDITIONAL' not found in library
aclocal:configure.ac:1015: warning: macro `AM_CONDITIONAL' not found in library
aclocal:configure.ac:1105: warning: macro `AM_CONDITIONAL' not found in library
aclocal:configure.ac:1229: warning: macro `AM_CONDITIONAL' not found in library
configure.ac:2: error: Autoconf version 2.63 or higher is required
configure.ac:2: the top level
autom4te: /usr/bin/m4 failed with exit status: 63
aclocal: autom4te failed with exit status: 63
</code></pre>

<p>別のエラーが出てしまい、なおかつ、参照先のパスが変更できなかった。</p>

<h2 id="automake-%E3%81%AE%E3%83%93%E3%83%AB%E3%83%89%E2%86%92%E5%A4%B1%E6%95%97">automake のビルド→失敗</h2>

<p>それならば、ということで今度は <code>automake</code> をビルドしてみることにした。</p>

<p>とりあえず、 <a href="http://ftp.gnu.org/gnu/automake/?C=M;O=D">GNU Project Archives</a> からダウンロード＆解凍。</p>

<pre><code class="bash"># cd ..
# pwd
~/build
# curl -kLO http://ftp.gnu.org/gnu/automake/automake-1.15.tar.xz
# tar xf automake-1.15.tar.xz
# cd automake-1.15
</code></pre>

<p>そして <code>configure</code> をしてみると、、、</p>

<pre><code class="bash"># ./configure  --prefix=$HOME/usr/automake
checking whether make supports nested variables... yes
checking build system type... i686-pc-linux-gnu
checking host system type... i686-pc-linux-gnu
checking for a BSD-compatible install... /usr/bin/install -c
checking whether build environment is sane... yes
checking for a thread-safe mkdir -p... /usr/bin/mkdir -p
checking for gawk... gawk
checking whether make sets $(MAKE)... yes
checking whether ln -s works... yes
checking for perl... /usr/local/bin/perl
checking for tex... no
checking for yacc... yacc
checking for lex... lex
checking whether autoconf is installed... yes
checking whether autoconf works... yes
checking whether autoconf is recent enough... no
configure: error: Autoconf 2.65 or better is required.
</code></pre>

<p>！！！ <code>Autoconf 2.65 or better is required.</code> なん、、、だと？</p>

<p>ぐぬぬ</p>

<h2 id="autoconf-2.65-%E3%81%AE%E3%83%93%E3%83%AB%E3%83%89%E2%86%92%E5%A4%B1%E6%95%97">Autoconf 2.65 のビルド→失敗</h2>

<pre><code class="bash"># cd ..
# pwd
~/build
# curl -OL http://ftpmirror.gnu.org/autoconf/autoconf-2.69.tar.gz
# tar xzf autoconf-2.69.tar.gz
# cd autoconf-2.69
# ./configure --prefix=$HOME/usr/autoconf
checking for a BSD-compatible install... /usr/bin/install -c
checking whether build environment is sane... yes
checking for a thread-safe mkdir -p... /usr/bin/mkdir -p
checking for gawk... gawk
checking whether make sets $(MAKE)... yes
checking build system type... i686-pc-linux-gnu
checking host system type... i686-pc-linux-gnu
configure: autobuild project... GNU Autoconf
configure: autobuild revision... 2.69
configure: autobuild hostname... s152
configure: autobuild timestamp... 20150530T042915Z
checking whether /bin/sh -n is known to work... yes
checking for characters that cannot appear in file names... none
checking whether directories can have trailing spaces... yes
checking for expr... /usr/bin/expr
checking for GNU M4 that supports accurate traces... configure: error: no acceptable m4 could be found in $PATH.
GNU M4 1.4.6 or later is required; 1.4.16 or newer is recommended.
GNU M4 1.4.15 uses a buggy replacement strstr on some systems.
Glibc 2.9 - 2.12 and GNU M4 1.4.11 - 1.4.15 have another strstr bug.
</code></pre>

<p>ぐぬぬ</p>

<h2 id="m4-1.4.17-%E3%82%92%E3%83%93%E3%83%AB%E3%83%89%EF%BC%86%E3%82%A4%E3%83%B3%E3%82%B9%E3%83%88%E3%83%BC%E3%83%AB%E2%86%92%E6%88%90%E5%8A%9F">m4 1.4.17 をビルド＆インストール→成功</h2>

<pre><code class="bash"># cd ..
# pwd
~/build
# curl -OL http://ftp.gnu.org/gnu/m4/m4-1.4.17.tar.xz
# tar xf m4-1.4.17.tar.xz
# cd m4-1.4.17
# ./configure --prefix=$HOME/usr/m4
# make
# make install
</code></pre>

<h2 id="autoconf-2.65-%E3%81%AE%E3%83%93%E3%83%AB%E3%83%89%EF%BC%86%E3%82%A4%E3%83%B3%E3%82%B9%E3%83%88%E3%83%BC%E3%83%AB%E2%86%92%E6%88%90%E5%8A%9F">Autoconf 2.65 のビルド＆インストール→成功</h2>

<pre><code class="bash"># cd ../autoconf-2.69
# pwd
~/build/autoconf-2.69
# PATH=$HOME/usr/m4/bin:$PATH ./configure --prefix=$HOME/usr/autoconf
# PATH=$HOME/usr/m4/bin:$PATH make
# PATH=$HOME/usr/m4/bin:$PATH make install
</code></pre>

<h2 id="automake-1.15-%E3%81%AE%E3%83%93%E3%83%AB%E3%83%89%EF%BC%86%E3%82%A4%E3%83%B3%E3%82%B9%E3%83%88%E3%83%BC%E3%83%AB%E2%86%92%E6%88%90%E5%8A%9F">Automake 1.15 のビルド＆インストール→成功</h2>

<pre><code class="bash"># cd ../automake-1.15
# pwd
~/build/automake-1.15
# PATH=$HOME/usr/autoconf/bin:$PATH ./configure --prefix=$HOME/usr/automake
# PATH=$HOME/usr/autoconf/bin:$PATH make
# PATH=$HOME/usr/autoconf/bin:$PATH make install
</code></pre>

<h2 id="libxml-%E3%81%AE%E3%83%93%E3%83%AB%E3%83%89%E2%86%92%E5%A4%B1%E6%95%97">libxml のビルド→失敗</h2>

<pre><code class="bash"># cd ../libxml2-2.9.2
# pwd
~/build/libxml2-2.9.2
# mkdir m4
# PATH=$HOME/usr/autoconf/bin:$HOME/usr/m4/bin:$HOME/usr/automake/bin:$PATH aclocal
# PATH=$HOME/usr/autoconf/bin:$HOME/usr/m4/bin:$HOME/usr/automake/bin:$PATH autoheader
# PATH=$HOME/usr/autoconf/bin:$HOME/usr/m4/bin:$HOME/usr/automake/bin:$PATH automake
configure.ac:52: warning: AM_INIT_AUTOMAKE: two- and three-arguments forms are deprecated.  For more info, see:
configure.ac:52: http://www.gnu.org/software/automake/manual/automake.html#Modernize-AM_005fINIT_005fAUTOMAKE-invocation
Makefile.am:22: error: Libtool library used but 'LIBTOOL' is undefined
Makefile.am:22:   The usual way to define 'LIBTOOL' is to add 'LT_INIT'
Makefile.am:22:   to 'configure.ac' and run 'aclocal' and 'autoconf' again.
Makefile.am:22:   If 'LT_INIT' is in 'configure.ac', make sure
Makefile.am:22:   its definition is in aclocal's search path.
                         :
    # PATH=$HOME/usr/autoconf/bin:$HOME/usr/m4/bin:$HOME/usr/automake/bin:$PATH autoscan
    # PATH=$HOME/usr/autoconf/bin:$HOME/usr/m4/bin:$HOME/usr/automake/bin:$PATH autoconf
    # PATH=$HOME/usr/automake/share/automake-1.15/:$PATH ./configure --prefix=$HOME/usr/libxml
</code></pre>

<p>なんか LibTool も居るみたい。</p>

<h2 id="libtool-2.4.6-%E3%81%AE%E3%82%A4%E3%83%B3%E3%82%B9%E3%83%88%E3%83%BC%E3%83%AB%EF%BC%86%E3%83%93%E3%83%AB%E3%83%89%E2%86%92%E6%88%90%E5%8A%9F">LibTool 2.4.6 のインストール＆ビルド→成功</h2>

<pre><code class="bash"># cd ..
# pwd
~/build
# curl -OL http://ftp.gnu.org/gnu/libtool/libtool-2.4.6.tar.xz
# tar xf libtool-2.4.6.tar.xz
# cd libtool-2.4.6
# PATH=$HOME/usr/m4/bin:$PATH ./configure --prefix=$HOME/usr/libtool
# make
# make install
</code></pre>

<h2 id="3-%E5%BA%A6%E7%9B%AE%E3%81%AE%E6%AD%A3%E7%9B%B4%E3%81%AA-libxml-%E3%81%AE%E3%83%93%E3%83%AB%E3%83%89%EF%BC%86%E3%82%A4%E3%83%B3%E3%82%B9%E3%83%88%E3%83%BC%E3%83%AB%E2%86%92%E6%88%90%E5%8A%9F">3 度目の正直な libxml のビルド＆インストール→成功</h2>

<pre><code class="bash"># cd ../libxml2-2.9.2
# pwd
~/build/libxml2-2.9.2
# PATH=$HOME/usr/libtool/bin:$PATH libtoolize
# PATH=$HOME/usr/autoconf/bin:$HOME/usr/m4/bin:$HOME/usr/automake/bin:$PATH aclocal
# PATH=$HOME/usr/autoconf/bin:$HOME/usr/m4/bin:$HOME/usr/automake/bin:$PATH autoheader
# PATH=$HOME/usr/autoconf/bin:$HOME/usr/m4/bin:$HOME/usr/automake/bin:$PATH automake --add-missing
# PATH=$HOME/usr/autoconf/bin:$HOME/usr/m4/bin:$HOME/usr/automake/bin:$PATH autoconf
# PATH=$HOME/usr/automake/share/automake-1.15/:$PATH ./configure --prefix=$HOME/usr/libxml --without-python
                           :
Checking lzma
./configure: line 13094: syntax error near unexpected token `LZMA,liblzma,'
./configure: line 13094: `    PKG_CHECK_MODULES(LZMA,liblzma,'
</code></pre>

<p>と <code>configure</code> 時にエラーが出るので少し修正。</p>

<pre><code class="bash"># cp configure configure.old 
# vi configure
# diff configure.old configure
13094,13096c13094,13096
&lt;     PKG_CHECK_MODULES(LZMA,liblzma,
&lt;         have_liblzma=yes,
&lt;         have_liblzma=no)
---
&gt;     #PKG_CHECK_MODULES(LZMA,liblzma,
&gt;     #    have_liblzma=yes,
&gt;     #    have_liblzma=no)
# PATH=$HOME/usr/automake/share/automake-1.15/:$PATH ./configure --prefix=$HOME/usr/libxml --without-python
# make
# make install
</code></pre>

<p>ちなみに <code>--without-python</code> オプションを指定しないと、システムディレクトリにインストール使用としてエラーが出てしまいます。
インストール先のディレクトリを指定してもいいけど、まあ要らないので省いています。</p>

<h2 id="sculpin-%E3%81%AE%E5%8B%95%E4%BD%9C%E7%A2%BA%E8%AA%8D">Sculpin の動作確認</h2>

<pre><code class="bash"># LD_PRELOAD=~/usr/libxml/lib/libxml2.so php55cli sculpin.phar
Sculpin version 2.0.x-dev (v2.0.0-46-g0862cc9) - app/dev/debug

Usage:
 [options] command [arguments]
               :
theme
 theme:list        List currently installed themes.
</code></pre>

<p>と、うまく動くようになりました。</p>

<h2 id="%E3%81%BE%E3%81%A8%E3%82%81">まとめ</h2>

<p>とりあえず、依存関係は</p>

<pre><code class="mermaid">graph LR
    libtool  --&gt; m4
    libxml   --&gt; m4
    libxml   --&gt; libtool
    libxml   --&gt; automake
    libxml   --&gt; autoconf
    automake --&gt; autoconf
</code></pre>

<p>とこのようになっていました。</p>

<p>ビルドは、</p>

<ol>
<li>m4</li>
<li>libtool</li>
<li>autoconf</li>
<li>automake</li>
<li>libxml</li>
</ol>

<p>の順でビルドしていくのが良いと思います。</p>

<p>実際のコマンドラインは、</p>

<p>まず、 <code>libxml</code> のビルドに必要なツール類のビルドを、</p>

<pre><code class="bash"># mkdir -p build $HOME/usr/buildtools
# cd build
# for I in http://ftp.gnu.org/gnu/m4/m4-1.4.17.tar.xz http://ftp.gnu.org/gnu/libtool/libtool-2.4.6.tar.xz http://ftpmirror.gnu.org/autoconf/autoconf-2.69.tar.gz http://ftp.gnu.org/gnu/automake/automake-1.15.tar.xz ; do curl -LO $I ; done
# for I in m4-1.4.17 libtool-2.4.6 autoconf-2.69 automake-1.15 ; do tar xf $I.tar.* ; pushd $I ; PATH=$HOME/usr/buildtools/bin:$PATH ./configure --prefix=$HOME/usr/buildtools ; PATH=$HOME/usr/buildtools/bin:$PATH make ; PATH=$HOME/usr/buildtools/bin:$PATH make install ; popd ; done
</code></pre>

<p>と、こんな感じで、 <code>$HOME/usr/buildtools</code> の下にインストールを行い、</p>

<pre><code class="bash"># curl -kLO https://git.gnome.org/browse/libxml2/snapshot/libxml2-2.9.2.tar.xz
# tar xf libxml2-2.9.2.tar.xz
# pushd libxml2-2.9.2
# for I in libtoolize aclocal autoheader "automake --add-missing" autoconf ; do PATH=$HOME/usr/buildtools/bin:$PATH $I ; done
# sed -e 's/PKG_CHECK_MODULES(LZMA/#\0/g' -e 's/^        have_liblzma=/#\0/g' configure &gt; configure~ ; mv -f configure~ configure ; chmod +x configure
# for I in "./configure --prefix=$HOME/usr/libxml --without-python" make "make install" ; do PATH=$HOME/usr/buildtools/bin:$HOME/usr/buildtools/share/automake-1.15/:$PATH $I ; done
# popd
</code></pre>

<p>以上の感じで <code>libxml</code> をビルドすることが出来ると思います。</p>

<pre><code class="bash"># ls -l ~/usr/libxml/*
~/usr/libxml/bin:
total 156
-rwxr-xr-x  1 guest users   1684 2015-05-31 21:16 xml2-config
-rwxr-xr-x  1 guest users  27475 2015-05-31 21:16 xmlcatalog
-rwxr-xr-x  1 guest users 124327 2015-05-31 21:16 xmllint

~/usr/libxml/include:
total 0
drwxr-xr-x  3 guest users 72 2015-05-31 21:16 libxml2

~/usr/libxml/lib:
total 7139
drwxr-xr-x  3 guest users      72 2015-05-31 21:16 cmake
-rw-r--r--  1 guest users 4103164 2015-05-31 21:16 libxml2.a
-rwxr-xr-x  1 guest users     975 2015-05-31 21:16 libxml2.la
lrwxrwxrwx  1 guest users      16 2015-05-31 21:16 libxml2.so -&gt; libxml2.so.2.9.2
lrwxrwxrwx  1 guest users      16 2015-05-31 21:16 libxml2.so.2 -&gt; libxml2.so.2.9.2
-rwxr-xr-x  1 guest users 3188079 2015-05-31 21:16 libxml2.so.2.9.2
drwxr-xr-x  2 guest users      80 2015-05-31 21:16 pkgconfig
-rw-r--r--  1 guest users     254 2015-05-31 21:16 xml2Conf.sh

~/usr/libxml/share:
total 0
drwxr-xr-x  2 guest users 80 2015-05-31 21:16 aclocal
drwxr-xr-x  3 guest users 80 2015-05-31 21:16 doc
drwxr-xr-x  3 guest users 72 2015-05-31 21:16 gtk-doc
drwxr-xr-x  4 guest users 96 2015-05-31 21:16 man
</code></pre>

<h2 id="%E5%8F%82%E8%80%83">参考</h2>

<ul>
<li><a href="http://qiita.com/ikedahidenori/items/8e533a9c168e269c4191">CORESERVERにgitをインストールする - Qiita</a></li>
<li><a href="https://git.gnome.org/browse/libxml2/">libxml2 - XML parser and markup toolkit</a></li>
<li><a href="http://www.xmlsoft.org/FAQ.html">FAQ</a></li>
<li><a href="http://nopipi.hatenablog.com/entry/2013/01/14/025509">configureの作り方(autotoolsの使い方） - メモ。。メモ。。</a></li>
<li><a href="https://bugs.archlinux.org/task/20172#comments">FS#20172 : [progsreiserfs] underquoted definition of AC_CHECK_LIBREISERFS</a></li>
<li><a href="http://stackoverflow.com/questions/16612791/automake-demands-autoconf-2-65-or-better-and-yet-i-already-have-autoconf-2-69">Automake demands "Autoconf 2.65 or better" and yet I already have Autoconf 2.69 installed - Stack Overflow</a></li>
<li><a href="https://github.com/dirkvdb/ffmpegthumbnailer/issues/37">aclocal: couldn't open directory `m4': No such file or directory · Issue #37 · dirkvdb/ffmpegthumbnailer</a></li>
<li><a href="http://stackoverflow.com/questions/18978252/error-libtool-library-used-but-libtool-is-undefined#answer-18980043">c - error: Libtool library used but 'LIBTOOL' is undefined - Stack Overflow</a></li>
</ul>
]]></content>
        </entry>
            <entry>
            <title type="html"><![CDATA[QNAP TS-109II への syslog-ng の導入メモ]]></title>
            <link href="http://www.sharkpp.net/blog/2013/01/27/install-qnap-ts-109ii-syslog-ng.html"/>
            <updated>2013-01-27T13:27:00+00:00</updated>
            <id>http://www.sharkpp.net/blog/2013/01/27/install-qnap-ts-109ii-syslog-ng.html</id>
            <content type="html"><![CDATA[<p>なんか今使ってるNASも古くなってきたけど、まだまだ現役です。</p>

<p>ってことで、ルーターのログを取るために QNAP TS-109II への syslog-ng の導入をしたときのメモです。</p>

<h4 id="%E3%82%A4%E3%83%B3%E3%82%B9%E3%83%88%E3%83%BC%E3%83%AB">インストール</h4>

<pre><code># ipkg update
# ipkg install syslog-ng
</code></pre>

<h4 id="%E8%A8%AD%E5%AE%9A%E3%81%AE%E7%B7%A8%E9%9B%86">設定の編集</h4>

<pre><code># vi /opt/etc/syslog-ng/syslog-ng.conf
</code></pre>

<p>とりあえず、必須の設定</p>

<p>下記の２行を削除して</p>

<pre><code>source src { pipe("/proc/kmsg");unix-stream("/dev/log"); internal(); };
source net { udp(); };
</code></pre>

<p>設定を追加</p>

<pre><code>source src { file ("/proc/kmsg" log_prefix("kernel: ")); unix-stream ("/tmp/log"); internal(); };
source net { udp(ip(0.0.0.0) port(514)); tcp(ip(0.0.0.0) port(514)); };
</code></pre>

<p>これをしないと、</p>

<pre><code>Error binding socket; addr='AF_UNIX(/dev/log)', error='Address already in use (98)'
Error initializing source driver; source='src'
</code></pre>

<p>などと怒られる。</p>

<p>今回の目的、ルーターのログを保存するために、設定を追加。 これを設定してなくて、しばらく、ログが出てこないのはなぜだろうと悩んだのはここだけの秘密。</p>

<pre><code>destination router { file("/opt/var/log/router.log"); };
filter f_router { match("APXXXXXXXXXXXX "); };
log { source(net); filter(f_router); destination(router); };
log { source(net); destination(messages); };
</code></pre>

<p>既存のsyslogの停止</p>

<pre><code># /sbin/daemon_mgr qsyslogd stop /sbin/qsyslogd
# /sbin/daemon_mgr syslogd stop /sbin/syslogd
</code></pre>

<p>syslog-ngの起動</p>

<pre><code># syslog-ng start
</code></pre>

<h4 id="%E3%82%B9%E3%82%BF%E3%83%BC%E3%83%88%E3%82%A2%E3%83%83%E3%83%97%E3%81%AB%E7%99%BB%E9%8C%B2">スタートアップに登録</h4>

<p>QPKGの設定に追加することで機能の有効無効がUIから操作でき、また、自動実行もされるようになる。</p>

<pre><code># vi /etc/config/qpkg.conf
</code></pre>

<p>で下記内容を追加</p>

<pre><code>[syslog-ng]
Name = syslog-ng
Date = 2013-01-25
Enable = TRUE
Shell = /share/HDA_DATA/.scripts/syslog-ng_qpkg_start.sh
Install_Path = /share/HDA_DATA/.qpkg/Optware/etc
Author = me

# vi /share/HDA_DATA/.scripts/syslog-ng_qpkg_start.sh
</code></pre>

<p>で下記内容を保存</p>

<pre><code>#!/bin/sh

QPKG_NAME="syslog-ng"

THIS_SCRIPT="[$(basename $0)]"
LOG=echo
OPT=/share/HDA_DATA/.qpkg/Optware
LOG_FILE=${OPT}/var/log/scripts.log
SLEEP=10

$LOG $THIS_SCRIPT $(date "+[%Y-%m-%d %H:%M:%S]") $QPKG_NAME $1 | tee -a $LOG_FILE

_exit() {
   $LOG $THIS_SCRIPT $(date "+[%Y-%m-%d %H:%M:%S]") "Error: " $* | tee -a $LOG_FILE
   exit 1
}

_log() {
   $LOG $THIS_SCRIPT $(date "+[%Y-%m-%d %H:%M:%S]") $* | tee -a $LOG_FILE
}

case "$1" in
   start)
   pidof syslog-ng &amp;&amp; _exit "$QPKG_NAME already running. Exiting."

   pidof qsyslogd &amp;&amp; _log "Found qsyslogd. Killing it." &amp;&amp; /sbin/daemon_mgr qsyslogd stop /sbin/qsyslogd 

   pidof syslogd &amp;&amp; _log "Found syslogd. Killing it." &amp;&amp; /sbin/daemon_mgr syslogd stop /sbin/syslogd 

   _log "Starting $QPKG_NAME"
   /opt/sbin/syslog-ng start
   pidof $QPKG_NAME &amp;&amp; _log "$QPKG_NAME up and running"
   ;;

   stop)
   killall syslog-ng
   ;;

   restart)
   $0 stop; $0 start
   ;;

   *)
   _exit "Unknown command $1. Usage: $0 {start|stop|restart}"
esac
exit 0
</code></pre>

<h4 id="logrotate%E3%82%92%E3%82%A4%E3%83%B3%E3%82%B9%E3%83%88%E3%83%BC%E3%83%AB">logrotateをインストール</h4>

<pre><code># ipkg update
# ipkg install logrotate
</code></pre>

<h4 id="logrotate%E3%81%AE%E8%A8%AD%E5%AE%9A%E3%82%92%E7%B7%A8%E9%9B%86">logrotateの設定を編集</h4>

<pre><code># vi /opt/etc/logrotate.conf

#rotate 5
weekly
missingok
notifempty
delaycompress
compress

/opt/var/log/*.log
/opt/var/log/mail.*
/opt/var/log/messages
/opt/var/log/debug
/opt/var/log/syslog {
   postrotate
       /share/HDA_DATA/.scripts/syslog-ng_qpkg_start.sh restart
   endscript
}
</code></pre>

<h4 id="%E5%AE%9A%E6%9C%9F%E5%AE%9F%E8%A1%8C%E3%81%AE%E3%81%9F%E3%82%81crontab%E3%81%AB%E7%99%BB%E9%8C%B2">定期実行のためcrontabに登録</h4>

<pre><code># crontab -e
</code></pre>

<p>で下記のように編集し</p>

<pre><code>0 21 * * * /opt/sbin/logrotate /opt/etc/logrotate.conf
</code></pre>

<p>下記のコマンドで反映</p>

<pre><code>/etc/init.d/crond.sh restart
</code></pre>

<p>とりあえず、ログのローテートとはまだ未確認だけどルーターのログを保存できるようになったしよしとしよう。</p>

<h3 id="%E5%8F%82%E8%80%83">参考</h3>

<ul>
<li><a href="http://forum.qnap.com/viewtopic.php?f=121&amp;t=17151">QNAP NAS Community Forum - View topic - [HOWTO] Syslog-ng- receive router logs</a></li>
<li><a href="http://forum.qnap.com/viewtopic.php?t=5379">QNAP NAS Community Forum - View topic - where to link optware auto-start</a></li>
<li><a href="http://forum.qnap.com/viewtopic.php?t=11507">QNAP NAS Community Forum - View topic - rsyslog</a></li>
<li><a href="http://tokusan-sk49.cocolog-nifty.com/blog/2010/05/qnapsyslog-ng-c.html">QNAPにsyslog-ng: とくさんブログ</a></li>
<li><a href="http://www.marronkun.net/linux/other/syslogng_000047.html">syslog-ng.confの設定 : マロンくん.NET</a></li>
<li><a href="http://www.atmarkit.co.jp/fsecurity/rensai/unix_sec09/unix_sec01.html">＠IT：止められないUNIXサーバの管理対策 第9回</a></li>
</ul>
]]></content>
        </entry>
            <entry>
            <title type="html"><![CDATA[QNAP TS-109II と GALAXY S(SC-02B) をOpenVPNで繋ぐ]]></title>
            <link href="http://www.sharkpp.net/blog/2011/12/10/qnap-ts-109-galaxys-openvpn.html"/>
            <updated>2011-12-10T16:15:00+00:00</updated>
            <id>http://www.sharkpp.net/blog/2011/12/10/qnap-ts-109-galaxys-openvpn.html</id>
            <content type="html"><![CDATA[<p>NAS(QNAP TS-109II)をゴニョゴニョやりながらなんとかOpenVPN使って、3G/WiFi経由でGALAXY S(SC-02B)と通信できたのでメモ。</p>

<ul>
<li><a href="http://blog.circlea4.net/?p=406">QNAPへのインターネット経由でのOpenVPNアクセス</a></li>
<li><a href="http://wiki.nas-portal.org/index.php/Install_OpenVPN_on_QNAP">Install OpenVPN on QNAP - NAS Wiki</a></li>
<li><a href="http://photo.viasv.com/?p=3269">ViaPress inc. - SC-02B OpenVPN for Android</a></li>
<li><a href="http://beautiful-moon.net/2011-03-05_android-xperia-openvpn/">beautiful-moon.net - Blog Archive - Xperia(Android)からOpenVPN接続</a></li>
</ul>

<p>あたりを参考にした。</p>

<p>いずれも自己責任でお願いします。</p>

<p>特にAndroid側はroot化が必要なので高級文鎮にならないように注意が必要です。</p>

<p>最終的に</p>

<ul>
<li>QNAP TS-109II側の設定</li>
<li>GALAXY S(SC-02B)側の設定</li>
<li>LAN内部のクライアントと通信する</li>
</ul>

<p>と、順にGALAXY S⇔QNAP⇔WindowsPCまで通信できるようになりました。</p>

<h3 id="qnap-ts-109ii%E5%81%B4%E3%81%AE%E8%A8%AD%E5%AE%9A">QNAP TS-109II側の設定</h3>

<p>Optware ipkg は、<a href="/blog/2011/12/05/using-subversion-with-qnap-ts109II.html">QNAP TS-109II で Subversionを使う</a> で色々やったのでそちらを参考にしてください。</p>

<h4 id="openvpn%E3%82%92%E3%82%A4%E3%83%B3%E3%82%B9%E3%83%88%E3%83%BC%E3%83%AB">OpenVPNをインストール</h4>

<pre># ipkg install openvpn
</pre>

<pre># openvpn
</pre>

<p>で動けばとりあえずOK</p>

<h4 id="%E3%83%AD%E3%82%B0%E3%83%87%E3%82%A3%E3%83%AC%E3%82%AF%E3%83%88%E3%83%AA%E3%82%84tun%E3%83%A2%E3%82%B8%E3%83%A5%E3%83%BC%E3%83%AB%E7%94%A8%E3%81%AE%E3%83%87%E3%82%A3%E3%83%AC%E3%82%AF%E3%83%88%E3%83%AA%E3%82%92%E7%94%9F%E6%88%90">ログディレクトリやtunモジュール用のディレクトリを生成</h4>

<pre># cd /opt/etc/openvpn
---
title: "mkdir log"
date: 2011-12-10 16:15:00
tags: [雑記, Android, QNAP, Galaxy S]
categories: [ブログ]

---
---
title: "cd log"
date: 2011-12-10 16:15:00
tags: [雑記, Android, QNAP, Galaxy S]
categories: [ブログ]

---
---
title: "touch openvpn.log"
date: 2011-12-10 16:15:00
tags: [雑記, Android, QNAP, Galaxy S]
categories: [ブログ]

---
---
title: "touch status.log"
date: 2011-12-10 16:15:00
tags: [雑記, Android, QNAP, Galaxy S]
categories: [ブログ]

---
---
title: "mkdir /opt/etc/openvpn/modules"
date: 2011-12-10 16:15:00
tags: [雑記, Android, QNAP, Galaxy S]
categories: [ブログ]

---
</pre>

<p><a href="http://wiki.nas-portal.org/index.php/Install_OpenVPN_on_QNAP#Install_the_missing_tun.ko_module">Install the missing tun.ko module</a>から適切なtunモジュールをダウンロードし</p>

<pre>/opt/etc/openvpn/modules
</pre>

<p>に配置</p>

<p>起動時に、</p>

<pre># install tun.ko
mkdir /dev/net;
mknod /dev/net/tun c 10 200;
(sleep 10; insmod /opt/etc/openvpn/modules/tun.ko)&
easy.confの内容
---
title: "exec openvpn"
date: 2011-12-10 16:15:00
tags: [雑記, Android, QNAP, Galaxy S]
categories: [ブログ]

---
(sleep 10; /opt/sbin/openvpn /opt/etc/openvpn/easy.conf)&
</pre>

<p>が実行されるように、autorun.shなどに書き加える</p>

<p>easy.confの内容</p>

<pre># OpenVPN server configuration QNAP NAS
---
title: "basic settings"
date: 2011-12-10 16:15:00
tags: [雑記, Android, QNAP, Galaxy S]
categories: [ブログ]

---
port 1194
proto udp
dev tun
#
---
title: "detect mtu if the connection is slow."
date: 2011-12-10 16:15:00
tags: [雑記, Android, QNAP, Galaxy S]
categories: [ブログ]

---
; mtu-test
#
---
title: "define mtu, if necessary"
date: 2011-12-10 16:15:00
tags: [雑記, Android, QNAP, Galaxy S]
categories: [ブログ]

---
; tun-mtu xyz
#
---
title: "define the ip-addresses of the underlying tunnel"
date: 2011-12-10 16:15:00
tags: [雑記, Android, QNAP, Galaxy S]
categories: [ブログ]

---
server 10.8.0.0 255.255.255.0
#
---
title: "Route"
date: 2011-12-10 16:15:00
tags: [雑記, Android, QNAP, Galaxy S]
categories: [ブログ]

---
push "route 192.168.1.0 255.255.255.0"   #  &lt;--- LANのIPアドレスを指定
#
---
title: "certificates & keys"
date: 2011-12-10 16:15:00
tags: [雑記, Android, QNAP, Galaxy S]
categories: [ブログ]

---
dh   /opt/etc/openvpn/keys/dh1024.pem
ca   /opt/etc/openvpn/keys/ca.crt
cert /opt/etc/openvpn/keys/server.crt
key  /opt/etc/openvpn/keys/server.key
#
---
title: "data compression"
date: 2011-12-10 16:15:00
tags: [雑記, Android, QNAP, Galaxy S]
categories: [ブログ]

---
comp-lzo
#
---
title: "allow, that several clients with the same common name log on"
date: 2011-12-10 16:15:00
tags: [雑記, Android, QNAP, Galaxy S]
categories: [ブログ]

---
; duplicate-cn
#
---
title: "different clients can "see" each other through the tunnel."
date: 2011-12-10 16:15:00
tags: [雑記, Android, QNAP, Galaxy S]
categories: [ブログ]

---
; client-to-client
#
---
title: "Keepalive"
date: 2011-12-10 16:15:00
tags: [雑記, Android, QNAP, Galaxy S]
categories: [ブログ]

---
keepalive 15 120
#
---
title: "verbosity of status messages in the console. Activate for debugging (1-9 possible)"
date: 2011-12-10 16:15:00
tags: [雑記, Android, QNAP, Galaxy S]
categories: [ブログ]

---
; verb 5
#
---
title: "Log files"
date: 2011-12-10 16:15:00
tags: [雑記, Android, QNAP, Galaxy S]
categories: [ブログ]

---
status /share/HDA_DATA/system/log/openvpn-status.log
log-append /share/HDA_DATA/system/log/openvpn.log
#
---
title: "Run as daemon (activate, after everything is set up properly)"
date: 2011-12-10 16:15:00
tags: [雑記, Android, QNAP, Galaxy S]
categories: [ブログ]

---
; daemon
#
---
title: "Management Interface. Access with "telnet localhost 7505""
date: 2011-12-10 16:15:00
tags: [雑記, Android, QNAP, Galaxy S]
categories: [ブログ]

---
management localhost 7505
</pre>

<h3 id="galaxy-ssc-02b%E5%81%B4%E3%81%AE%E8%A8%AD%E5%AE%9A">GALAXY S(SC-02B)側の設定</h3>

<h4 id="android-market%E3%81%8B%E3%82%89%E5%BF%85%E8%A6%81%E3%81%AA%E3%82%A2%E3%83%97%E3%83%AA%E3%82%92%E3%82%A4%E3%83%B3%E3%82%B9%E3%83%88%E3%83%BC%E3%83%AB">Android Marketから必要なアプリをインストール</h4>

<p><a href="https://market.android.com/details?id=stericson.busybox&amp;hl=ja">BusyBox</a>、<a href="https://market.android.com/details?id=de.schaeuffelhut.android.openvpn.installer&amp;hl=ja">OpenVPN Installer</a>、<a href="https://market.android.com/details?id=de.schaeuffelhut.android.openvpn&amp;hl=ja">OpenVPN Settings</a>をインストール</p>

<p>あと、ターミナルソフト(<a href="https://market.android.com/details?id=org.connectbot">ConnectBot</a>/<a href="https://market.android.com/details?id=jackpal.androidterm">Android Terminal Emulator</a>など) or adbでも出来るかも？ も必要</p>

<p>OpenVPN関連のインストール先は、</p>

<pre>/system/xbin/
</pre>

<p>ifconfig/route関連のインストール先は、</p>

<pre>/system/xbin/bb/
</pre>

<p>にしました。</p>

<h4 id="ifconfig%2Froute%E3%81%AE%E9%85%8D%E7%BD%AE">ifconfig/routeの配置</h4>

<pre>su
---
title: "mount -o remount,rw /dev/block/stl9 /system"
date: 2011-12-10 16:15:00
tags: [雑記, Android, QNAP, Galaxy S]
categories: [ブログ]

---
---
title: "mkdir /system/xbin/bb"
date: 2011-12-10 16:15:00
tags: [雑記, Android, QNAP, Galaxy S]
categories: [ブログ]

---
---
title: "ln -s /system/xbin/busybox /system/xbin/bb/ifconfig"
date: 2011-12-10 16:15:00
tags: [雑記, Android, QNAP, Galaxy S]
categories: [ブログ]

---
---
title: "ln -s /system/xbin/busybox /system/xbin/bb/route"
date: 2011-12-10 16:15:00
tags: [雑記, Android, QNAP, Galaxy S]
categories: [ブログ]

---
</pre>

<p>で一旦、GALAXY Sを再起動</p>

<p>/sdcard/openvpn/galaxys/</p>

<p>にGALAXY S用のtunドライバ(tun-I9000-JPK.zip)を配置</p>

<p>※<a href="http://forum.xda-developers.com/showthread.php?t=793712">HOWTO tun.ko to run OpenVPN on Froyo xxJPK Galaxy S I9000 - xda-developers</a>からダウンロード</p>

<p>OpenVPN Settingsを起動して、Advancedを開き、</p>

<ol>
<li>「Load tun kernel module」にチェック</li>
<li>「TUN module settings」</li>
<li>　「Load modules usings」→ insmod を選択</li>
<li>　「Path to tun module」→ /sdcard/openvpn/galaxys/tun.ko と指定</li>
</ol>

<p><a href="http://wiki.nas-portal.org/index.php/Install_OpenVPN_on_QNAP#Key-generation">Key-generation</a>の手順で認証キーなどを作る</p>

<p>それぞれ、必要なファイルを指定したパス(/sdcard/openvpn/ca/)にアップ</p>

<p>vpn.confを配置</p>

<pre>/sdcard/openvpn/vpn.conf
</pre>

<p>に配置</p>

<p>vpn.confの内容</p>

<pre># connect to QNAP OpenVPN Server
script-security 2
proto udp
dev tun
tls-client
remote vpn.example.net 1194  #  &lt;--- enter your dyndns-account here!
pull
---
title: "set mtu, if necessary"
date: 2011-12-10 16:15:00
tags: [雑記, Android, QNAP, Galaxy S]
categories: [ブログ]

---
tun-mtu 1500
#
resolv-retry infinite
nobind
persist-key
persist-tun
---
title: "certificates and keys"
date: 2011-12-10 16:15:00
tags: [雑記, Android, QNAP, Galaxy S]
categories: [ブログ]

---
---
title: "Note the double \\ in the path for a windows config"
date: 2011-12-10 16:15:00
tags: [雑記, Android, QNAP, Galaxy S]
categories: [ブログ]

---
ca   /sdcard/openvpn/ca/ca.crt
cert /sdcard/openvpn/ca/key.crt
key  /sdcard/openvpn/ca/key.key
#
comp-lzo
#status /sdcard/openvpn/status.log
#log-append /sdcard/openvpn/log.log
</pre>

<p>設定の内容はサーバー側の設定と合わせないとうまく繋がりません。</p>

<p>ログを出力するようにしておくと原因の究明に役立つでしょう。</p>

<p>3Gだと実装で20kbpsも出ませんでしたのでまあやれることは限られていますがVPNで繋がるようになりました。</p>

<h3 id="lan%E5%86%85%E9%83%A8%E3%81%AE%E3%82%AF%E3%83%A9%E3%82%A4%E3%82%A2%E3%83%B3%E3%83%88%E3%81%A8%E9%80%9A%E4%BF%A1%E3%81%99%E3%82%8B">LAN内部のクライアントと通信する</h3>

<p><a href="http://wiki.nas-portal.org/index.php/OpenVPN_Extras">OpenVPN Extras - NAS Wiki</a>を参考</p>

<h4 id="qnap%E5%81%B4vpn%E3%82%B5%E3%83%BC%E3%83%90%E3%83%BC%E3%81%A7ipv4%E3%81%AE%E8%BB%A2%E9%80%81%E3%82%92%E6%9C%89%E5%8A%B9%E3%81%AB%E3%81%99%E3%82%8B">QNAP側(VPNサーバー)でipv4の転送を有効にする</h4>

<p>下記コマンドを 起動時に実行されるようにしておく</p>

<pre>echo "1" &gt; /proc/sys/net/ipv4/ip_forward
</pre>

<h4 id="windows-pc%E3%81%AE%E3%83%95%E3%82%A1%E3%82%A4%E3%83%AB%E5%85%B1%E6%9C%89%E3%82%92%E8%A6%8B%E3%82%8B">Windows PCのファイル共有を見る</h4>

<p>まず、クライアント側で</p>

<pre>C:\&gt; route -p add 10.8.0.0 MASK 255.255.255.0 QNAPのアドレス
</pre>

<p>としてパケットを送り返すことが出来るようにしておく。</p>

<p>ちなみに、-p を指定しておくとPCを再起動しても設定した内容を覚えておいてくれます。</p>

<pre>C:\&gt; route add ほげほげ
エラー: ネットワーク データベース ファイル ﾀﾉE を開けません
エラー: ネットワーク データベース ファイル ﾀﾉE を開けません
</pre>

<p>見たいに、エラーが出る場合は、自己の責任においてレジストリの</p>

<p>HKLM\SYSTEM\CurrentControlSet\Services\Tcpip\Parameters\DataBasePath</p>

<p>を、REG&#95;SZからREG&#95;EXPANG_SZに変えてみてください。</p>

<p>まえ、boost::asioでサンプルがうまく動かなかったのはこれが原因かもと今更気が付いた。</p>

<p>ここで、Windows PC⇔Galaxy S でpingの疎通確認をしておく</p>

<p>※Windows PC側は、pingの応答を返さないようになっていることが良くあるので設定を変更しておくこと</p>

<p>※ICMPの「エコー要求の着信を許可する」をONにしておくこと</p>

<p>問題なければ、ファイヤーウォールでファイル共有がローカルエリア外から接続できるかを確認</p>

<p>Windowsファイヤーウォールの場合</p>

<ol>
<li>「例外」</li>
<li>「ファイルとプリンタの共有」</li>
<li>「スコープの変更」</li>
<li>「ユーザーのネットワークのみ」になっていたら「カスタム一覧」にして「10.8.0.0/255.255.255.0,192.168.1.0/255.255.255.0」などに変更</li>
</ol>

<p>で、接続できると思います。</p>

<p>出来なかったら、Wiresharkで確認するのがイイです。</p>
]]></content>
        </entry>
            <entry>
            <title type="html"><![CDATA[QNAP TS-109II で Subversionを使う]]></title>
            <link href="http://www.sharkpp.net/blog/2011/12/05/using-subversion-with-qnap-ts109II.html"/>
            <updated>2011-12-05T00:23:00+00:00</updated>
            <id>http://www.sharkpp.net/blog/2011/12/05/using-subversion-with-qnap-ts109II.html</id>
            <content type="html"><![CDATA[<p>久しぶりに、NAS(QNAP TS-109II)の環境を作り直したのでメモ。</p>

<p>元々はsubversionを入れたいがためにdebianを入れていたけど、どうもそんな小難しいことをしなくてもSubversionを動かせるって情報を見つけたので今の環境を破棄してまで試してみる。</p>

<p>結論から言うとバックアップやら何やらで時間はかかったけど問題なく動きそう。</p>

<ul>
<li><a href="http://forum.qnap.com/viewtopic.php?f=32&amp;t=1779">Subversion over HTTP</a></li>
<li><a href="http://wiki.qnap.com/wiki/Subversion">Subversion - QNAPedia</a></li>
<li><a href="http://d.hatena.ne.jp/sugarball/20111029/1319896597">QNAP TS-439 Pro II+ Turbo NASにSubversionを構築 - sugarballの日記</a></li>
</ul>

<p>あたりを参考に、NAS(QNAP TS-109II)に、Apache+Subversionの環境を作ってみた</p>

<h3 id="optware-ipkg%E3%82%92%E3%82%A4%E3%83%B3%E3%82%B9%E3%83%88%E3%83%BC%E3%83%AB">Optware IPKGをインストール</h3>

<p>ApacheやSubversionをインストールするのに必要なIPKGを追加。</p>

<p><a href="http://wiki.qnap.com/wiki/Install_Optware_IPKG">Install Optware IPKG - QNAPedia</a>を参考にインストール。</p>

<ol>
<li>QNAPの管理画面を開く</li>
<li>「ホーム」→「アプリケーション」→「QPKGプラグイン」を開く</li>
<li>「QPKGの取得」を押下し、「Optware IPKG (Itsy Package Management System)」をダウンロード＆解凍</li>
<li>解凍した、"Optware_?.qpkg" を、「インストール」タブからインストール</li>
<li>「QPKGインストール済み」タブから、「Optware IPKG」を選び、「有効にする」を押下し有効にする</li>
</ol>

<p>有効にした直後のみipkgコマンドへパスが通るが、リブート以降パスが通らなくなるので</p>

<pre>export PATH=$PATH:/opt/bin:/opt/sbin
</pre>

<p>としておく</p>

<h3 id="apache2%E3%82%92%E3%82%A4%E3%83%B3%E3%82%B9%E3%83%88%E3%83%BC%E3%83%AB">Apache2をインストール</h3>

<p>ipkg install apache</p>

<p>すると↓のように mod&#95;ext&#95;filter.so が読み込めないとエラーが出る。</p>

<pre>httpd: Syntax error on line 74 of /opt/etc/apache2/httpd.conf: Cannot load /opt/libexec/mod_ext_filter.so into server: /opt/libexec/mod_ext_filter.so: undefined symbol: apr_procattr_limit_set<br />httpd: Syntax error on line 74 of /opt/etc/apache2/httpd.conf: Cannot load /opt/libexec/mod_ext_filter.so into server: /opt/libexec/mod_ext_filter.so: undefined symbol: apr_procattr_limit_set
</pre>

<p><a href="http://forum.synology.com/enu/viewtopic.php?f=34&amp;t=40959">mod&#95;ext&#95;filter.so: undefined symbol: apr&#95;procattr&#95;limit_set</a> を参考に設定を変更。</p>

<p>参考ページでも結局モジュールを読まないように変えるしかないようだ。</p>

<pre>vi /opt/etc/apache2/httpd.conf
</pre>

<p>で設定ファイルから libexec/mod&#95;ext&#95;filter.so を探しコメントアウト。</p>

<pre>httpd: bad user name nobody
</pre>

<p>と言われるのでユーザーを追加。</p>

<ol>
<li>QNAPの管理画面を開く</li>
<li>「ホーム」→「アクセス権管理」→「ユーザー」を開く</li>
<li>「ユーザーの追加」を押下</li>
</ol>

<ul>
<li>ユーザ名:nobody</li>
<li>容量制限の設定：無効にする</li>
<li>グループ：administrators, everyone</li>
<li>読み込みのみ：&#45;--</li>
<li>読み取り／書き込み：Public, Qdownload, Qmultimedia ...</li>
<li>アクセス拒否：&#45;--</li>
</ul>

<p>で追加</p>

<pre>httpd: Could not reliably determine the server's fully qualified domain name, using ? for ServerName
</pre>

<p>と言われるので設定を書き換え。</p>

<pre>ServerName nasserver:888
</pre>

<p>とかこんな感じ</p>

<p>もちろん例の場合、</p>

<pre>Listen 888
</pre>

<p>としておかないといけない</p>

<p>やることとしては、</p>

<ul>
<li>mod&#95;ext&#95;filter.so の設定を、httpd.conf からコメントアウト</li>
<li>ServerName(変更するならListenも)の設定を、httpd.conf に指定</li>
<li>QNAP管理画面から、nobodyユーザーを追加。</li>
</ul>

<pre>/opt/sbin/httpd -k start
</pre>

<p>で起動して http://nasserver:888/ などにブラウザでアクセスし、</p>

<p>It works!</p>

<p>と表示されたらOK</p>

<h3 id="subversion%E3%82%92%E3%82%A4%E3%83%B3%E3%82%B9%E3%83%88%E3%83%BC%E3%83%AB">Subversionをインストール</h3>

<pre>ipkg install svn
</pre>

<p>httpd.conf に↓を追加</p>

<pre>Include etc/apache2/conf.d/*.conf
</pre>

<p>レポジトリは、</p>

<pre>/share/HDA_DATA/svn
</pre>

<p>に設置</p>

<p>認証用のファイルは、</p>

<pre>/share/HDA_DATA/Qweb/repos/
</pre>

<p>に置く</p>

<p>HDA_DATAの部分は、製品によって違うようだ</p>

<p>.authz や .htpasswd</p>

<p>vi /opt/etc/apache2/conf.d/mod&#95;dav&#95;svn.conf に</p>

<pre>&lt;IfModule dav_svn_module&gt;<br /> &lt;Location "/repos/"&gt;<br />  DAV svn<br />  SVNParentPath /share/HDA_DATA/svn<br />  SVNListParentPath on<br />  AuthzSVNAccessFile /share/HDA_DATA/Qweb/repos/.authz<br />  &lt;IfModule dav_svn_module&gt;<br />   AuthType Basic<br />   AuthName "Authentication"<br />   AuthUserFile /share/HDA_DATA/Qweb/repos/.htpasswd<br />   Require valid-user<br />  &lt;/IfModule&gt;<br /> &lt;/Location&gt;<br /> &lt;Directory /share/HDA_DATA/Qweb/repos&gt;<br />  AllowOverride All<br />  Options All<br />  &lt;Limit GET POST OPTIONS&gt;<br />   Order allow,deny<br />   Allow from all<br />  &lt;/Limit&gt;<br />  &lt;LimitExcept GET POST OPTIONS PROPFIND MKACTIVITY CHECKOUT MKACTIVITY DELETE PROPPATCH MKCOL MERGE REPORT PUT COPY&gt;<br />   Order deny,allow<br />   Deny from all<br />  &lt;/LimitExcept&gt;<br /> &lt;/Directory&gt;<br />&lt;/IfModule&gt;
</pre>

<p>を追加。</p>

<pre>mkdir /share/HDA_DATA/svn<br />cd /share/HDA_DATA/svn<br />svnadmin create test
</pre>

<p>などしてレポジトリを作る</p>

<h3 id="apache%E3%81%AE%E8%87%AA%E5%8B%95%E8%B5%B7%E5%8B%95">Apacheの自動起動</h3>

<p><a href="http://wiki.qnap.com/wiki/Autorun.sh">Running Your Own Application at Startup - QNAPedia</a>を参考に</p>

<p>autorun.sh を編集</p>

<p>いちいちマウントするのが面倒なので、<a href="http://wiki.qnap.com/wiki/Autorun.sh#Method_3">Method 3</a> 方式で</p>

<p>/share/HDA_DATA/.qpkg/autorun/autorun.sh に</p>

<pre>(sleep 10; /opt/sbin/httpd -k start ) &
</pre>

<p>と追加</p>
]]></content>
        </entry>
    </feed>