name: build

on:
  push:
    branches:
    - master

jobs:
  build-deploy:

    runs-on: ubuntu-18.04
    steps:

    - name: Setup PHP 7.4
      run: sudo update-alternatives --set php /usr/bin/php7.4

    - name: setup node
      uses: actions/setup-node@v1
      with:
        node-version: '10.16'

    - name: install bower
      run: npm install -g bower

    - name: Checkout master
      uses: actions/checkout@master

    - name: Cache composer packages
      uses: actions/cache@v3
      id: composer-cache
      with:
        path: |
          .vendor
        key: ${{ runner.OS }}-composer-cache-${{ hashFiles('**/composer.lock') }}
        restore-keys: |
          ${{ runner.OS }}-composer-cache-

    - name: Cache bower packages
      uses: actions/cache@v3
      id: bower-cache
      with:
        path: |
          .bower
          source/assets
        key: ${{ runner.OS }}-bower-cache-${{ hashFiles('**/.bower.json') }}
        restore-keys: |
          ${{ runner.OS }}-bower-cache-

    - name: composer install
      if: steps.composer-cache.outputs.cache-hit != 'true'
      run: php ./composer.phar install -n --prefer-dist

    - name: bower install
      if: steps.bower-cache.outputs.cache-hit != 'true'
      run: php .vendor/beelab/bowerphp/bin/bowerphp install

    - name: Build
      run: ./site deploy
      env:
        REPO_SLUG: sharkpp/www.sharkpp.net

    - name: Deploy
      uses: peaceiris/actions-gh-pages@v3
      with:
        github_token: ${{ secrets.GITHUB_TOKEN }}
        publish_branch: gh-pages
        publish_dir: ./output_prod
