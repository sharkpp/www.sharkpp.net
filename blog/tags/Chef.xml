<?xml version="1.0" encoding="utf-8"?>
<feed xmlns="http://www.w3.org/2005/Atom">
    <title><![CDATA[さめたすたすのお家]]></title>
    <link href="https://www.sharkpp.net/blog/tags/Chef.xml" rel="self"/>
    <link href="https://www.sharkpp.net/"/>
    <updated>2024-12-31T10:59:09+00:00</updated>
    <id>https://www.sharkpp.net/</id>
            <author>
            <name><![CDATA[sharkpp]]></name>                    </author>
        <generator uri="http://sculpin.io/">Sculpin</generator>
            <entry>
            <title type="html"><![CDATA[Opscode Community に自作の Cookbook を登録してみた]]></title>
            <link href="https://www.sharkpp.net/blog/2014/06/30/publish-cookbook-to-opscode.html"/>
            <updated>2014-06-30T00:20:00+00:00</updated>
            <id>https://www.sharkpp.net/blog/2014/06/30/publish-cookbook-to-opscode.html</id>
            <content type="html"><![CDATA[<p>必要に迫られて作成した <a href="https://github.com/sharkpp-cookbooks/ya-piwik">ya-piwik</a> を &#91;Opscode Community&#93; (http://community.opscode.com/) に登録してみました。 もしか、動かなかったりするかもですがそのときはタイミングを見て直そうかと思います。 とりあえず自分所では動いています。</p>

<p>登録した Cookbook は <a href="http://community.opscode.com/cookbooks/ya-piwik">Chef Cookbook: ya-piwik - Opscode Community</a> から確認できます。</p>

<h2 id="%E3%82%A2%E3%82%AB%E3%82%A6%E3%83%B3%E3%83%88%E7%99%BB%E9%8C%B2">アカウント登録</h2>

<p>まず、&#91;Opscode Community&#93; (http://community.opscode.com/) の右上の <a href="http://community.opscode.com/users/new">Sign up</a> からアカウント登録します。</p>

<p>アカウント登録後に、 private key が表示されますが、Cookbook の登録には必要ありません。</p>

<h2 id="cookbook-%E3%82%92%E7%99%BB%E9%8C%B2">Cookbook を登録</h2>

<h3 id="%E6%BA%96%E5%82%99">準備</h3>

<p>Cookbook の登録は tarball として固めたファイルをアップロードするので、</p>

<pre><code>COOKBOOK_NAME
 +-- README.md
 +-- metadata.json
 +-- recipes
 |    +-- default.rb 
 +-- attributes
      +-- default.rb 
</code></pre>

<p>の用な感じでルートも含めて圧縮します。 なお zip 形式でも認識するようです。</p>

<p>また、 Cookbook を登録するときには <code>metadata.json</code> が必要となるようです。</p>

<p>metadata.rb から metadata.json を作成するには</p>

<pre><code># cd COOKBOOK_NAME
# knife cookbook metadata -o ../ COOKBOOK_NAME
</code></pre>

<p>とすれば OK です。</p>

<h3 id="%E7%99%BB%E9%8C%B2">登録</h3>

<p><a href="http://community.opscode.com/cookbooks">Cookbook</a> から <a href="http://community.opscode.com/cookbooks/new">Add New Cookbook</a> をたどり Cookbook を登録します。 (トップページからは追加のリンクが無いようでちょっと迷いました)</p>

<p>タグは付けなくてよいようです。</p>

<p>ya-piwik は次のように入力しました。</p>

<p><img src="/images/2014_0630_add_new_ya_piwik_field_fill.png" alt="" /></p>

<p>ついでに登録後に Edit cookbook からホームページの登録が出来るので github のページなどを登録しておきます。</p>

<h3 id="%E7%99%BB%E9%8C%B2%E6%99%82%E3%81%AE%E3%82%A8%E3%83%A9%E3%83%BC%E3%81%A8%E5%AF%BE%E5%87%A6%E6%96%B9%E6%B3%95">登録時のエラーと対処方法</h3>

<p>最後に Cookbook 登録時に表示されるエラーの対処方法を数は少ないですがまとめました。</p>

<ul>
<li><code>"Cookbook must contain metadata.json"</code> - <code>metadata.json</code> が存在していないので追加する必要が有る</li>
<li><code>"Cookbook folder must match cookbook name"</code> - tarball内のルートのフォルダ名がcookbookと一致していない(例えば、githubのZIPダウンロードしたファイルのように)</li>
<li><code>"Cookbook must contain only a single directory"</code> - 1つのCookbookのみを追加できる(Macで圧縮するとMacリソースが含まれてしまうことが有るので注意！)</li>
</ul>
]]></content>
        </entry>
            <entry>
            <title type="html"><![CDATA[はじめてのChef]]></title>
            <link href="https://www.sharkpp.net/blog/2014/04/18/first-step-chef.html"/>
            <updated>2014-04-18T23:15:00+00:00</updated>
            <id>https://www.sharkpp.net/blog/2014/04/18/first-step-chef.html</id>
            <content type="html"><![CDATA[<h2 id="%E7%9B%AE%E6%A8%99">目標</h2>

<p>母艦であるところの Mac から、VirtualBox で構築した VM や VPS に対して環境を構築したい。 が、最初は、 <a href="http://www.getchef.com/">Chef</a> で遊んでみることに。</p>

<h2 id="%E6%BA%96%E5%82%99">準備</h2>

<p>とりあえず、 VirtualBox で VM を立ち上げて確認してみる。</p>

<p>母艦であるところの Mac 側で、 Chef と knife-solo と berkshelf をインストールします。</p>

<p>VM 側は、後で Mac 側からインストールするので特に何もインストールする必要はないですが、SSHの設定はやっておくのが吉っぽいです。</p>

<p>まず始めに、</p>

<pre><code>$ gem install chef
</code></pre>

<p>したら</p>

<pre><code>You don't have write permissions into the /Library/Ruby/Gems/1.8 directory.
</code></pre>

<p>ってしばらくして怒られたので、権限を与えて実行</p>

<pre><code>$ sudo gem install chef
</code></pre>

<p>で、やっぱりしばらくしたら、</p>

<pre><code>ERROR:  Error installing chef:
mime-types requires Ruby version &gt;= 1.9.2.
</code></pre>

<p>って Ruby の新しいバージョンが必要だよって怒られた(´・ω・｀)</p>

<p>確認したら、</p>

<pre><code>$ ruby -v
ruby 1.8.7 (2012-02-08 patchlevel 358) [universal-darwin12.0]
</code></pre>

<p>確かに古いね。</p>

<p>ってことで、新しいバージョンを<a href="/blog/2014/04/15/ruby-1-9-3-install-for-mac-10-8.html">インストール</a>。</p>

<pre><code>$ ruby -v
ruby 1.9.3p545 (2014-02-24 revision 45159) [x86_64-darwin12.5.0]
</code></pre>

<p>で、</p>

<pre><code>$ sudo gem install chef --no-ri --no-rdoc
Fetching: mixlib-config-2.1.0.gem (100%)
                   :
25 gems installed
</code></pre>

<p>今度は大丈夫。</p>

<pre><code>$ chef-client -v
Chef: 11.12.2
</code></pre>

<p>次に、 knife-solo をインストール</p>

<pre><code>$ sudo gem install knife-solo --no-ri --no-rdoc
               :
Successfully installed knife-solo-0.4.1
1 gem installed
</code></pre>

<p>で、こっちはすんなりインストール</p>

<p>続いて、 Berkshelf をインストール</p>

<pre><code>$ sudo gem install berkshelf --no-ri --no-rdoc
</code></pre>

<h2 id="knife-configure">knife configure</h2>

<pre><code>$ knife configure
WARNING: No knife configuration file found
Where should I put the config file? [/Users/***/.chef/knife.rb] 
ERROR: Ohai::Exceptions::DependencyNotFound: Can not find a plugin for dependency os
</code></pre>

<p>「<a href="http://qiita.com/sakatuba@github/items/1548818b02735b2047ad">Chef 11.12.2のknife configureが失敗する - Qiita</a>」によると、バグッてるので古いバージョンを使えってことのよう(´・ω・｀)</p>

<p>とりあえず、エラー表示でググるのって大事だよねってことで。</p>

<pre><code>$ sudo gem uninstall chef ; sudo gem install chef --no-ri --no-rdoc -v 11.10.0
</code></pre>

<p>で、古いバージョンをインストール。</p>

<pre><code>$ chef-client -v
Chef: 11.10.0
</code></pre>

<p>気を取り直して、</p>

<pre><code>$ knife configure
WARNING: No knife configuration file found
Where should I put the config file? [/Users/***/.chef/knife.rb] 
Please enter the chef server URL: [https://****:443] 
                    :
Configuration file written to /Users/***/.chef/knife.rb
$
</code></pre>

<p>今度はうまく行きました。</p>

<h2 id="%E3%83%AC%E3%83%9D%E3%82%B8%E3%83%88%E3%83%AA%E3%81%AE%E4%BD%9C%E6%88%90">レポジトリの作成</h2>

<p>chef-repo って名前でレポジトリを作成します。</p>

<pre><code>$ knife solo init chef-repo
Creating kitchen...
Creating knife.rb in kitchen...
Creating cupboards...
Setting up Berkshelf...
$ cd chef-repo
</code></pre>

<p>この時、 Berkshelf がインストール済みだと、一緒に Berksfile ファイルも作ってくれます。 とりあえず、 nginx を Berkshelf を使いインストールしてみます。</p>

<pre><code>$ echo cookbook 'yum'&gt;&gt;Berkshelf
$ echo cookbook 'nginx'&gt;&gt;Berkshelf
$ berks install
</code></pre>

<p>で、VM 側に Chef をインストール。</p>

<pre><code>$ knife solo prepare root@192.168.56.102
</code></pre>

<p>SSH鍵を使う場合は</p>

<pre><code>$ knife solo prepare -i path/to/key_file root@192.168.56.102
</code></pre>

<p>ってするようです。</p>

<p>「<a href="http://tsuchikazu.net/chef_solo_start/">Chef Soloの正しい始め方 | tsuchikazu blog</a>」に書いてあるように、</p>

<pre><code>{"run_list":[
  "yum::epel", 
  "nginx"
]}
</code></pre>

<p>として、</p>

<pre><code>$ knife solo cook root@192.168.56.102
</code></pre>

<p>実行すると、</p>

<pre><code>could not find recipe epel for cookbook yum
</code></pre>

<p>ってエラーが出るので、</p>

<pre><code>{"run_list":[
  "yum", 
  "nginx"
]}
</code></pre>

<p>と、書き換えて、</p>

<pre><code>$ knife cookbook create base -o site-cookbooks/
$ open -e site-cookbooks/base/recipesdefault.rb
</code></pre>

<p>として、「<a href="http://kimikimi714.hatenablog.com/entry/2014/01/13/%E3%82%B5%E3%83%BC%E3%83%89%E3%83%91%E3%83%BC%E3%83%86%E3%82%A3%E8%A3%BDchef%E3%83%AC%E3%82%B7%E3%83%94%E4%BD%BF%E3%81%A3%E3%81%A6%E3%81%9F%E3%81%AE%E5%BF%98%E3%82%8C%E3%81%A6%E3%81%9F">サードパーティ製chefレシピ使ってたの忘れてた - わすれっぽいきみえ</a>」を参考に追加。</p>

<pre><code># add the EPEL repo
yum_repository 'epel' do
  description 'Extra Packages for Enterprise Linux'
  mirrorlist 'http://mirrors.fedoraproject.org/mirrorlist?repo=epel-6&amp;arch=$basearch'
  fastestmirror_enabled true
  gpgkey 'http://dl.fedoraproject.org/pub/epel/RPM-GPG-KEY-EPEL-6'
  action :create
end

# add the Remi repo
yum_repository 'remi' do
  description 'Les RPM de Remi - Repository'
  baseurl 'http://rpms.famillecollet.com/enterprise/6/remi/x86_64/'
  gpgkey 'http://rpms.famillecollet.com/RPM-GPG-KEY-remi'
  fastestmirror_enabled true
  action :create
end
</code></pre>

<p>で、</p>

<pre><code>$ knife solo cook root@192.168.56.102
</code></pre>

<p>を実行し、しばらくすると、完了します。</p>

<p>ブラウザでアクセスすると、、、、見えませんでした。 少し考えて、 VM 側に SSH で入り</p>

<pre><code># netstat -apn|grep "LISTEN "
tcp        0      0 0.0.0.0:80                  0.0.0.0:*                   LISTEN      2124/nginx          
tcp        0      0 0.0.0.0:22                  0.0.0.0:*                   LISTEN      987/sshd            
tcp        0      0 127.0.0.1:25                0.0.0.0:*                   LISTEN      1063/master         
tcp        0      0 :::22                       :::*                        LISTEN      987/sshd            
tcp        0      0 ::1:25                      :::*                        LISTEN      1063/master         
</code></pre>

<p>確認したところ、LISTENは出来てる所が確認できたところで、FWでブロックされていることに気が付きました。</p>

<p>ってところで、以下次回？</p>

<h2 id="%E5%8F%82%E8%80%83">参考</h2>

<ul>
<li><a href="http://www.atmarkit.co.jp/ait/articles/1305/24/news003.html">特集 DevOps時代の必須知識：インフラストラクチャ自動化フレームワーク「Chef」の基本 (1/2) - ＠IT</a></li>
<li><a href="http://docs.opscode.com/install_workstation.html#run-the-omnibus-installer">Install Chef 11.x on a Workstation - Chef Docs</a></li>
<li><a href="http://qiita.com/takeshi_ok_desu/items/936ee44b712c37d25a0e">http://qiita.com/takeshi&#95;ok&#95;desu/items/936ee44b712c37d25a0e</a></li>
<li><a href="http://tsuchikazu.net/chef_solo_start/">Chef Soloの正しい始め方 | tsuchikazu blog</a></li>
<li><a href="http://qiita.com/sakatuba@github/items/1548818b02735b2047ad">Chef 11.12.2のknife configureが失敗する - Qiita</a></li>
<li><a href="http://kimikimi714.hatenablog.com/entry/2014/01/13/%E3%82%B5%E3%83%BC%E3%83%89%E3%83%91%E3%83%BC%E3%83%86%E3%82%A3%E8%A3%BDchef%E3%83%AC%E3%82%B7%E3%83%94%E4%BD%BF%E3%81%A3%E3%81%A6%E3%81%9F%E3%81%AE%E5%BF%98%E3%82%8C%E3%81%A6%E3%81%9F">サードパーティ製chefレシピ使ってたの忘れてた - わすれっぽいきみえ</a></li>
</ul>
]]></content>
        </entry>
    </feed>